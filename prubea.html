<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KYB seen</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBcjjoLZ3XU3SD8xgT6XmvZEVrmoV34A4M",
      authDomain: "kyb-seen.firebaseapp.com",
      projectId: "kyb-seen",
      storageBucket: "kyb-seen.firebasestorage.app",
      messagingSenderId: "916013840344",
      appId: "1:916013840344:web:561274a6db9470a7ca64ad",
      measurementId: "G-1C8ZDYR1JS"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    
    // Hacer disponibles globalmente
    window.firebaseAuth = auth;
    window.firebaseStorage = storage;
    window.firebaseAuthFunctions = {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      updateProfile
    };
    window.firebaseStorageFunctions = {
      ref,
      uploadBytes,
      getDownloadURL
    };
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .fade-in {
      animation: fadeIn 1.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite;
    }
    
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.6); }
    }
    
    .hover-zoom {
      transition: transform 0.3s ease;
    }
    
    .hover-zoom:hover {
      transform: scale(1.05);
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .ripple:active::after {
      width: 300px;
      height: 300px;
    }
    
    .input-glow:focus {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      border-color: #10b981;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #10b981, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .series-card {
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
      backdrop-filter: blur(10px);
    }
    
    .parallax-header {
      background-size: cover;
      background-position: center;
      transition: transform 0.3s ease-out;
    }
    
    .chat-bubble {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .star-rating {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .star-rating:hover {
      transform: scale(1.2);
    }
    
    .loader {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(16, 185, 129, 0.2);
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .eye-icon {
      transition: all 0.3s ease;
    }
    
    .eye-icon.watched {
      color: #10b981;
      transform: scale(1.1);
    }
    
    .smooth-scroll {
      scroll-behavior: smooth;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1f2937;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #10b981;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #059669;
    }
    
    .notification-dot {
      width: 8px;
      height: 8px;
      background-color: #ef4444;
      border-radius: 50%;
      position: absolute;
      top: 8px;
      right: 8px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .avatar-option {
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }
    
    .avatar-option:hover {
      transform: scale(1.1);
    }
    
    .avatar-option.selected {
      border-color: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-900 text-white overflow-auto">
  <div id="app" class="h-full w-full"></div>
  <script>
    // Configuraci√≥n por defecto
    const defaultConfig = {
      app_name: "KYB seen",
      tagline: "Tu comunidad BL/GL",
      popular_title: "Popular",
      bl_title: "BL",
      gl_title: "GL",
      popular_color: "#10b981",
      bl_color: "#ec4899",
      gl_color: "#a855f7",
      background_color: "#111827",
      card_color: "#1f2937",
      text_color: "#ffffff",
      accent_color: "#10b981",
      secondary_accent: "#ec4899",
      login_button: "Iniciar Sesi√≥n",
      signup_button: "Crear Cuenta",
      guest_button: "Entrar como Invitado",
      font_family: "Inter",
      font_size: 16
    };
    
    // Admins que pueden crear polls y series del mes
    const ADMIN_EMAILS = ['soportedekyb@gmail.com', 'elihuf07@gmail.com'];
    
    // Estado global de la aplicaci√≥n
    let appState = {
      currentScreen: 'splash',
      currentUser: null,
      userProfile: null, // Perfil completo del usuario con foto y community_name
      isGuest: false,
      selectedSeries: null,
      userData: [],
      currentSeriesData: [],
      hasUnreadPoll: false
    };
    
    // Biblioteca de avatares (personajes de series)
    const avatarLibrary = [
      { id: 'bad-buddy', series: 'Bad Buddy', emoji: 'üé∏' },
      { id: 'semantic-error', series: 'Semantic Error', emoji: 'üíª' },
      { id: 'gap', series: 'GAP', emoji: 'üíº' },
      { id: 'cherry-magic', series: 'Cherry Magic', emoji: '‚ú®' },
      { id: 'we-best-love', series: 'We Best Love', emoji: '‚ù§Ô∏è' },
      { id: 'handmaiden', series: 'Handmaiden', emoji: 'üå∏' },
      { id: 'gameboys', series: 'Gameboys', emoji: 'üéÆ' },
      { id: 'tsukutabe', series: 'Tsukutabe', emoji: 'üçú' },
      { id: 'love-stage', series: 'Love Stage', emoji: '‚≠ê' },
      { id: 'bl-drama', series: 'BL Drama', emoji: 'üé≠' },
      { id: 'gl-series', series: 'GL Series', emoji: 'üåà' },
      { id: 'my-school', series: 'My School', emoji: 'üìö' }
    ];
    
    // Base de datos de series de ejemplo (referencia est√°tica)
    const seriesDatabase = [
      {
        id: 'bl-thailand-1',
        title: 'Bad Buddy',
        country: 'Thailand',
        genre: 'BL',
        year: 2021,
        episodes: 12,
        duration: '45 min',
        synopsis: 'Pat y Pran han sido rivales desde la infancia debido a sus familias. Pero cuando se hacen vecinos en la universidad, descubren que hay algo m√°s que rivalidad entre ellos.',
        cover: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Bad+Buddy',
        rating: 0,
        ratingCount: 0,
        category: 'popular'
      },
      {
        id: 'bl-korea-1',
        title: 'Semantic Error',
        country: 'Korea',
        genre: 'BL',
        year: 2022,
        episodes: 8,
        duration: '25 min',
        synopsis: 'Chu Sangwoo es un estudiante de inform√°tica perfeccionista que se ve obligado a trabajar con Jang Jaeyoung, un artista carism√°tico y ca√≥tico.',
        cover: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Semantic+Error',
        rating: 0,
        ratingCount: 0,
        category: 'bl'
      },
      {
        id: 'gl-thailand-1',
        title: 'GAP The Series',
        country: 'Thailand',
        genre: 'GL',
        year: 2022,
        episodes: 12,
        duration: '50 min',
        synopsis: 'Mon, una joven trabajadora, se enamora de su jefa Sam, una heredera fr√≠a y distante. Una historia de amor prohibido en el mundo corporativo.',
        cover: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=GAP',
        rating: 0,
        ratingCount: 0,
        category: 'popular'
      },
      {
        id: 'bl-japan-1',
        title: 'Cherry Magic',
        country: 'Japan',
        genre: 'BL',
        year: 2020,
        episodes: 12,
        duration: '30 min',
        synopsis: 'Adachi descubre que al cumplir 30 a√±os siendo virgen, puede leer las mentes de las personas que toca. Descubre que su compa√±ero Kurosawa est√° enamorado de √©l.',
        cover: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Cherry+Magic',
        rating: 0,
        ratingCount: 0,
        category: 'bl'
      },
      {
        id: 'bl-taiwan-1',
        title: 'We Best Love',
        country: 'Taiwan',
        genre: 'BL',
        year: 2021,
        episodes: 12,
        duration: '35 min',
        synopsis: 'Zhou Shuyi y Gao Shide han sido rivales durante a√±os, pero sus sentimientos van m√°s allÔøΩÔøΩ de la competencia acad√©mica.',
        cover: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=We+Best+Love',
        rating: 0,
        ratingCount: 0,
        category: 'bl'
      },
      {
        id: 'gl-korea-1',
        title: 'The Handmaiden',
        country: 'Korea',
        genre: 'GL',
        year: 2023,
        episodes: 10,
        duration: '40 min',
        synopsis: 'Una adaptaci√≥n moderna de una historia de amor entre dos mujeres de diferentes clases sociales.',
        cover: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=Handmaiden',
        rating: 0,
        ratingCount: 0,
        category: 'gl'
      },
      {
        id: 'bl-philippines-1',
        title: 'Gameboys',
        country: 'Philippines',
        genre: 'BL',
        year: 2020,
        episodes: 13,
        duration: '20 min',
        synopsis: 'Durante la cuarentena, Cairo conoce a Gavreel en un videojuego. Lo que comienza como amistad virtual se convierte en algo m√°s profundo.',
        cover: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Gameboys',
        rating: 0,
        ratingCount: 0,
        category: 'popular'
      },
      {
        id: 'gl-japan-1',
        title: 'Tsukutabe',
        country: 'Japan',
        genre: 'GL',
        year: 2023,
        episodes: 10,
        duration: '30 min',
        synopsis: 'Una historia sobre comida, amor y autodescubrimiento entre dos mujeres que comparten su pasi√≥n por la cocina.',
        cover: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=Tsukutabe',
        rating: 0,
        ratingCount: 0,
        category: 'gl'
      }
    ];
    
    // Handler para Data SDK
    const dataHandler = {
      onDataChanged(data) {
        appState.userData = data;
        
        // Actualizar perfil del usuario actual
        if (appState.currentUser && !appState.isGuest) {
          const profile = data.find(d => d.type === 'user_profile' && d.user_id === appState.currentUser.id);
          if (profile) {
            appState.userProfile = profile;
          }
        }
        
        // Verificar si hay polls sin leer
        const polls = data.filter(d => d.type === 'poll');
        const userVotes = data.filter(d => d.type === 'poll_vote' && d.user_id === appState.currentUser?.id);
        const votedPollIds = userVotes.map(v => v.poll_id);
        appState.hasUnreadPoll = polls.some(p => !votedPollIds.includes(p.poll_id));
        
        // Actualizar ratings de las series
        const ratings = data.filter(d => d.type === 'rating');
        seriesDatabase.forEach(series => {
          const seriesRatings = ratings.filter(r => r.series_id === series.id);
          if (seriesRatings.length > 0) {
            const sum = seriesRatings.reduce((acc, r) => acc + r.rating, 0);
            series.rating = sum / seriesRatings.length;
            series.ratingCount = seriesRatings.length;
          }
        });
        
        // Si estamos en la pantalla de serie, actualizar
        if (appState.currentScreen === 'series' && appState.selectedSeries) {
          renderSeriesScreen();
        }
        
        // Si estamos en polls, actualizar
        if (appState.currentScreen === 'polls') {
          renderPollsScreen();
        }
        
        // Si estamos en home, actualizar el header para mostrar notificaci√≥n
        if (appState.currentScreen === 'home') {
          renderHomeScreen();
        }
      }
    };
    
    // Funci√≥n para obtener el perfil de usuario
    function getUserProfile(userId) {
      return appState.userData.find(d => d.type === 'user_profile' && d.user_id === userId);
    }
    
    // Funci√≥n para renderizar la pantalla de carga
    function renderSplashScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const appName = window.elementSdk?.config?.app_name || defaultConfig.app_name;
      const tagline = window.elementSdk?.config?.tagline || defaultConfig.tagline;
      
      return `
        <div class="h-full w-full flex flex-col items-center justify-center fade-in" style="background-color: ${bgColor};">
          <div class="text-center">
            <h1 class="gradient-text mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 3}px; font-weight: 700;">${appName}</h1>
            <p class="mb-8" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.25}px; color: ${accentColor}; opacity: 0.9;">${tagline}</p>
            <div class="loader pulse-glow mx-auto" style="border-top-color: ${accentColor};"></div>
          </div>
        </div>
      `;
    }
    
    // Funci√≥n para renderizar la pantalla de login
    function renderLoginScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const secondaryAccent = window.elementSdk?.config?.secondary_accent || defaultConfig.secondary_accent;
      const appName = window.elementSdk?.config?.app_name || defaultConfig.app_name;
      const loginButton = window.elementSdk?.config?.login_button || defaultConfig.login_button;
      const signupButton = window.elementSdk?.config?.signup_button || defaultConfig.signup_button;
      const guestButton = window.elementSdk?.config?.guest_button || defaultConfig.guest_button;
      
      return `
        <div class="h-full w-full flex flex-col items-center justify-center px-6 fade-in" style="background-color: ${bgColor};">
          <div class="w-full max-w-md">
            <h1 class="gradient-text text-center mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 2.5}px; font-weight: 700;">${appName}</h1>
            <p class="text-center mb-8" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: ${accentColor}; opacity: 0.8;">Bienvenido a tu comunidad BL/GL</p>
            
            <form id="loginForm" class="space-y-4 mb-6">
              <div>
                <label for="email" class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Correo Electr√≥nico</label>
                <input 
                  type="email" 
                  id="email" 
                  required
                  class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                  style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  placeholder="tu@email.com"
                />
              </div>
              <div>
                <label for="password" class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Contrase√±a</label>
                <input 
                  type="password" 
                  id="password" 
                  required
                  class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                  style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
              <button 
                type="submit"
                class="w-full py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90"
                style="background: linear-gradient(135deg, ${accentColor}, ${secondaryAccent}); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px; color: white;"
              >
                ${loginButton}
              </button>
            </form>
            
            <button 
              id="signupBtn"
              class="w-full py-3 rounded-lg ripple font-semibold mb-4 transition-all hover:opacity-90"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px; color: ${accentColor};"
            >
              ${signupButton}
            </button>
            
            <button 
              id="guestBtn"
              class="w-full py-3 rounded-lg transition-all hover:opacity-70"
              style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: rgba(255, 255, 255, 0.6);"
            >
              ${guestButton}
            </button>
          </div>
        </div>
      `;
    }
    
    // Funci√≥n para renderizar la pantalla principal (Home)
    function renderHomeScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const popularTitle = window.elementSdk?.config?.popular_title || defaultConfig.popular_title;
      const blTitle = window.elementSdk?.config?.bl_title || defaultConfig.bl_title;
      const glTitle = window.elementSdk?.config?.gl_title || defaultConfig.gl_title;
      const appName = window.elementSdk?.config?.app_name || defaultConfig.app_name;
      
      const popularSeries = seriesDatabase.filter(s => s.category === 'popular');
      const blSeries = seriesDatabase.filter(s => s.genre === 'BL');
      const glSeries = seriesDatabase.filter(s => s.genre === 'GL');
      
      const countries = ['Thailand', 'Korea', 'Japan', 'Taiwan', 'Philippines'];
      
      // Avatar del usuario
      let userAvatar = 'üë§';
      if (appState.userProfile?.profile_picture) {
        if (appState.userProfile.profile_picture.startsWith('avatar-')) {
          const avatarId = appState.userProfile.profile_picture.replace('avatar-', '');
          const avatar = avatarLibrary.find(a => a.id === avatarId);
          if (avatar) userAvatar = avatar.emoji;
        }
      }
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <!-- Header -->
          <header class="sticky top-0 z-50 px-6 py-4 flex justify-between items-center" style="background: linear-gradient(180deg, ${bgColor} 0%, rgba(17, 24, 39, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <h1 class="gradient-text" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.75}px; font-weight: 700;">${appName}</h1>
            <div class="flex items-center gap-4">
              ${!appState.isGuest ? `
                <button id="pollsBtn" class="relative transition-all hover:opacity-80">
                  <svg class="w-8 h-8" fill="${accentColor}" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                  </svg>
                  ${appState.hasUnreadPoll ? '<div class="notification-dot"></div>' : ''}
                </button>
              ` : ''}
              <button id="profileBtn" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 1.5}px;">
                ${userAvatar}
              </button>
            </div>
          </header>
          
          <main class="px-6 py-6">
            <!-- Popular -->
            <section class="mb-8">
              <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: ${accentColor};">${popularTitle}</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${popularSeries.map(series => `
                  <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                    <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center" style="background: linear-gradient(135deg, #ec4899, #a855f7);">
                      <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8;">${series.title}</span>
                    </div>
                    <div class="p-3">
                      <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                      <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.genre} ‚Ä¢ ${series.country}</p>
                      ${series.ratingCount > 0 ? `
                        <div class="flex items-center mt-2">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </section>
            
            <!-- BL -->
            <section class="mb-8">
              <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: #ec4899;">${blTitle}</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${blSeries.slice(0, 4).map(series => `
                  <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                    <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
                      <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8;">${series.title}</span>
                    </div>
                    <div class="p-3">
                      <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                      <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.country}</p>
                      ${series.ratingCount > 0 ? `
                        <div class="flex items-center mt-2">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </section>
            
            <!-- GL -->
            <section class="mb-8">
              <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: #a855f7;">${glTitle}</h2>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${glSeries.map(series => `
                  <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                    <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center" style="background: linear-gradient(135deg, #a855f7, #c084fc);">
                      <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8;">${series.title}</span>
                    </div>
                    <div class="p-3">
                      <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                      <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.country}</p>
                      ${series.ratingCount > 0 ? `
                        <div class="flex items-center mt-2">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </section>
            
            <!-- Por Pa√≠s -->
            ${countries.map(country => {
              const countrySeries = seriesDatabase.filter(s => s.country === country).slice(0, 4);
              if (countrySeries.length === 0) return '';
              
              return `
                <section class="mb-8">
                  <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: ${accentColor};">${country}</h2>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${countrySeries.map(series => `
                      <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                        <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center" style="background: linear-gradient(135deg, ${series.genre === 'BL' ? '#ec4899' : '#a855f7'}, ${series.genre === 'BL' ? '#f472b6' : '#c084fc'});">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8;">${series.title}</span>
                        </div>
                        <div class="p-3">
                          <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                          <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.genre}</p>
                          ${series.ratingCount > 0 ? `
                            <div class="flex items-center mt-2">
                              <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </section>
              `;
            }).join('')}
          </main>
        </div>
      `;
    }
    
    // Funci√≥n para renderizar la pantalla de serie individual
    function renderSeriesScreen() {
      if (!appState.selectedSeries) return;
      
      const series = appState.selectedSeries;
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      // Obtener datos del usuario para esta serie
      const userEpisodes = appState.userData.filter(d => d.type === 'episode' && d.series_id === series.id && d.user_id === appState.currentUser?.id);
      const userRating = appState.userData.find(d => d.type === 'rating' && d.series_id === series.id && d.user_id === appState.currentUser?.id);
      const messages = appState.userData.filter(d => d.type === 'message' && d.series_id === series.id).sort((a, b) => a.timestamp - b.timestamp);
      
      const episodes = Array.from({ length: series.episodes }, (_, i) => i + 1);
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <!-- Header con parallax -->
          <div class="parallax-header relative" style="height: 40%; background: linear-gradient(180deg, rgba(17, 24, 39, 0.4), ${bgColor}), linear-gradient(135deg, ${series.genre === 'BL' ? '#ec4899' : '#a855f7'}, ${series.genre === 'BL' ? '#f472b6' : '#c084fc'});">
            <button id="backBtn" class="absolute top-4 left-4 w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);">
              <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            <div class="absolute bottom-4 left-6">
              <h1 class="font-bold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 2}px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">${series.title}</h1>
              <p style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; opacity: 0.9;">${series.genre} ‚Ä¢ ${series.country} ‚Ä¢ ${series.year}</p>
            </div>
          </div>
          
          <main class="px-6 py-6">
            <!-- Informaci√≥n -->
            <section class="mb-6">
              <p class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; line-height: 1.6; opacity: 0.9;">${series.synopsis}</p>
              <div class="grid grid-cols-2 gap-4 text-sm" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
                <div>
                  <span class="opacity-70">Episodios:</span>
                  <span class="ml-2 font-semibold">${series.episodes}</span>
                </div>
                <div>
                  <span class="opacity-70">Duraci√≥n:</span>
                  <span class="ml-2 font-semibold">${series.duration}</span>
                </div>
              </div>
            </section>
            
            <!-- Calificaci√≥n -->
            <section class="mb-6 p-4 rounded-lg" style="background-color: rgba(31, 41, 55, 0.6);">
              <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Calificaci√≥n</h3>
              ${series.ratingCount > 0 ? `
                <p class="mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)} <span style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7;">(${series.ratingCount} calificaciones)</span></p>
              ` : `
                <p class="mb-2 opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Sin calificaciones a√∫n</p>
              `}
              ${appState.currentUser && !appState.isGuest ? `
                <div class="flex gap-2">
                  ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => `
                    <button class="star-rating ${userRating?.rating === rating ? 'opacity-100' : 'opacity-40'}" data-rating="${rating}" style="font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">‚òÖ</button>
                  `).join('')}
                </div>
                ${userRating ? `<p class="mt-2 text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Tu calificaci√≥n: ${userRating.rating}/10</p>` : ''}
              ` : `
                <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Inicia sesi√≥n para calificar</p>
              `}
            </section>
            
            <!-- Episodios -->
            <section class="mb-6">
              <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Episodios</h3>
              <div class="space-y-2">
                ${episodes.map(ep => {
                  const watched = userEpisodes.some(ue => ue.episode_number === ep && ue.watched);
                  return `
                    <div class="flex items-center justify-between p-3 rounded-lg transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.6);">
                      <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">Episodio ${ep}</span>
                      ${appState.currentUser && !appState.isGuest ? `
                        <button class="eye-toggle ${watched ? 'watched' : ''}" data-episode="${ep}">
                          <svg class="w-6 h-6 eye-icon ${watched ? 'watched' : ''}" fill="currentColor" viewBox="0 0 24 24">
                            ${watched ? 
                              '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>' :
                              '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>'
                            }
                          </svg>
                        </button>
                      ` : `
                        <svg class="w-6 h-6 opacity-30" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                        </svg>
                      `}
                    </div>
                  `;
                }).join('')}
              </div>
              ${appState.isGuest ? `
                <p class="mt-3 text-sm text-center opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Crea una cuenta para marcar episodios</p>
              ` : ''}
            </section>
            
            <!-- Comunidad -->
            <section class="mb-6">
              <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Comunidad</h3>
              <div id="chatContainer" class="space-y-3 mb-4 max-h-80 overflow-y-auto p-4 rounded-lg" style="background-color: rgba(31, 41, 55, 0.4);">
                ${messages.length > 0 ? messages.map(msg => {
                  const msgProfile = getUserProfile(msg.user_id);
                  let avatar = 'üë§';
                  if (msgProfile?.profile_picture) {
                    if (msgProfile.profile_picture.startsWith('avatar-')) {
                      const avatarId = msgProfile.profile_picture.replace('avatar-', '');
                      const avatarData = avatarLibrary.find(a => a.id === avatarId);
                      if (avatarData) avatar = avatarData.emoji;
                    }
                  }
                  
                  return `
                    <div class="chat-bubble">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize}px;">
                          ${avatar}
                        </div>
                        <div class="flex-1">
                          <div class="flex items-baseline gap-2">
                            <p class="font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">${msg.username}</p>
                            ${msgProfile?.community_name ? `
                              <p class="text-xs opacity-60" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px;">@${msgProfile.community_name}</p>
                            ` : ''}
                          </div>
                          <p style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; opacity: 0.9;">${msg.message}</p>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('') : `
                  <p class="text-center opacity-50" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">No hay mensajes a√∫n. ¬°S√© el primero en comentar!</p>
                `}
              </div>
              
              ${appState.currentUser && !appState.isGuest ? `
                <form id="chatForm" class="flex gap-2">
                  <input 
                    type="text" 
                    id="chatInput" 
                    required
                    placeholder="Escribe tu mensaje..."
                    class="flex-1 px-4 py-3 rounded-lg input-glow transition-all"
                    style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  />
                  <button 
                    type="submit"
                    class="px-6 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90"
                    style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  >
                    Enviar
                  </button>
                </form>
              ` : `
                <p class="text-center text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Inicia sesi√≥n para participar en la comunidad</p>
              `}
            </section>
          </main>
        </div>
      `;
    }
    
    // Funci√≥n para renderizar el perfil
    function renderProfileScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const userSeries = [...new Set(appState.userData.filter(d => d.type === 'episode' && d.user_id === appState.currentUser?.id).map(d => d.series_id))];
      const userSeriesData = userSeries.map(sid => seriesDatabase.find(s => s.id === sid)).filter(Boolean);
      
      // Avatar del usuario
      let userAvatar = 'üë§';
      if (appState.userProfile?.profile_picture) {
        if (appState.userProfile.profile_picture.startsWith('avatar-')) {
          const avatarId = appState.userProfile.profile_picture.replace('avatar-', '');
          const avatar = avatarLibrary.find(a => a.id === avatarId);
          if (avatar) userAvatar = avatar.emoji;
        }
      }
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <header class="sticky top-0 z-50 px-6 py-4 flex justify-between items-center" style="background: linear-gradient(180deg, ${bgColor} 0%, rgba(17, 24, 39, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <button id="backToHomeBtn" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.8);">
              <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            <h1 style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600;">Mi Perfil</h1>
            <div class="w-10"></div>
          </header>
          
          <main class="px-6 py-6">
            ${appState.isGuest ? `
              <div class="text-center py-12">
                <div class="w-24 h-24 rounded-full mx-auto mb-4 flex items-center justify-center" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 3}px;">
                  üë§
                </div>
                <h2 class="mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600;">Modo Invitado</h2>
                <p class="mb-6 opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">Crea una cuenta para guardar tu progreso</p>
                <button id="goToLoginBtn" class="px-8 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;">
                  Crear Cuenta
                </button>
              </div>
            ` : `
              <div class="text-center mb-8">
                <div class="relative inline-block">
                  <button id="changeAvatarBtn" class="w-24 h-24 rounded-full mx-auto mb-4 flex items-center justify-center transition-all hover:opacity-80" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 3}px;">
                    ${userAvatar}
                  </button>
                  <button id="editAvatarIcon" class="absolute bottom-3 right-0 w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${accentColor};">
                    <svg class="w-5 h-5" fill="white" viewBox="0 0 24 24">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                </div>
                <h2 class="mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600;">${appState.currentUser.username}</h2>
                ${appState.userProfile?.community_name ? `
                  <p class="opacity-70 mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">@${appState.userProfile.community_name}</p>
                ` : ''}
                <p class="opacity-70 mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${appState.currentUser.email}</p>
                <button id="editProfileBtn" class="px-6 py-2 rounded-lg transition-all hover:opacity-80" style="border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">
                  Editar Perfil
                </button>
              </div>
              
              <section class="mb-6">
                <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Mi Lista</h3>
                ${userSeriesData.length > 0 ? `
                  <div class="space-y-3">
                    ${userSeriesData.map(series => {
                      const watchedCount = appState.userData.filter(d => d.type === 'episode' && d.series_id === series.id && d.user_id === appState.currentUser.id && d.watched).length;
                      const progress = (watchedCount / series.episodes) * 100;
                      
                      return `
                        <div class="series-card rounded-lg p-4 cursor-pointer hover-zoom" data-series-id="${series.id}">
                          <div class="flex justify-between items-start mb-2">
                            <div>
                              <h4 class="font-semibold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h4>
                              <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.genre} ‚Ä¢ ${series.country}</p>
                            </div>
                            <span class="text-sm" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">${watchedCount}/${series.episodes}</span>
                          </div>
                          <div class="w-full h-2 rounded-full overflow-hidden" style="background-color: rgba(31, 41, 55, 0.6);">
                            <div class="h-full transition-all" style="width: ${progress}%; background: linear-gradient(90deg, ${accentColor}, rgba(236, 72, 153, 0.8));"></div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : `
                  <p class="text-center py-8 opacity-50" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">No has marcado ning√∫n episodio a√∫n</p>
                `}
              </section>
              
              <button id="logoutBtn" class="w-full py-3 rounded-lg transition-all hover:opacity-70" style="border: 2px solid rgba(239, 68, 68, 0.5); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: rgba(239, 68, 68, 0.9);">
                Cerrar Sesi√≥n
              </button>
            `}
          </main>
        </div>
      `;
    }
    
    // Funci√≥n para renderizar pantalla de Polls
    function renderPollsScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const isAdmin = ADMIN_EMAILS.includes(appState.currentUser?.email);
      const canCreatePoll = isAdmin; // Admins pueden crear polls cualquier d√≠a
      
      // Obtener todas las polls
      const polls = appState.userData.filter(d => d.type === 'poll').sort((a, b) => b.timestamp - a.timestamp);
      const userVotes = appState.userData.filter(d => d.type === 'poll_vote' && d.user_id === appState.currentUser?.id);
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <header class="sticky top-0 z-50 px-6 py-4 flex justify-between items-center" style="background: linear-gradient(180deg, ${bgColor} 0%, rgba(17, 24, 39, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <button id="backToHomeFromPolls" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.8);">
              <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            <h1 style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600;">Polls</h1>
            <div class="flex gap-2">
              ${canCreatePoll ? `
                <button id="seriesOfMonthBtn" class="px-3 py-2 rounded-lg flex items-center gap-2 transition-all hover:opacity-80" style="background: linear-gradient(135deg, #a855f7, #ec4899); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px; color: white;">
                  ‚≠ê Serie del Mes
                </button>
                <button id="createPollBtn" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8));">
                  <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                </button>
              ` : '<div class="w-10"></div>'}
            </div>
          </header>
          
          <main class="px-6 py-6">
            <!-- Series del Mes -->
            ${(() => {
              const seriesOfMonth = appState.userData.filter(d => d.type === 'series_of_month').sort((a, b) => b.timestamp - a.timestamp);
              const currentMonth = seriesOfMonth[0];
              
              if (currentMonth) {
                const selectedSeries = JSON.parse(currentMonth.series_ids);
                const seriesData = selectedSeries.map(sid => seriesDatabase.find(s => s.id === sid)).filter(Boolean);
                const userVotes = appState.userData.filter(d => d.type === 'series_month_vote' && d.month_id === currentMonth.month_id);
                const userVote = userVotes.find(v => v.user_id === appState.currentUser?.id);
                const totalVotes = userVotes.length;
                
                // Contar votos por serie
                const voteCounts = {};
                selectedSeries.forEach(sid => voteCounts[sid] = 0);
                userVotes.forEach(vote => {
                  if (voteCounts[vote.series_id] !== undefined) {
                    voteCounts[vote.series_id]++;
                  }
                });
                
                return `
                  <section class="mb-8 p-5 rounded-lg" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2)); border: 2px solid rgba(168, 85, 247, 0.3);">
                    <div class="flex items-center justify-between mb-4">
                      <div class="flex items-center gap-2">
                        <span style="font-size: ${baseFontSize * 1.5}px;">‚≠ê</span>
                        <h2 class="font-bold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.25}px;">Serie del Mes</h2>
                      </div>
                      ${isAdmin ? `
                        <button onclick="deleteSeriesOfMonth('${currentMonth.month_id}')" class="w-8 h-8 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(239, 68, 68, 0.8);">
                          <svg class="w-5 h-5" fill="white" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                          </svg>
                        </button>
                      ` : ''}
                    </div>
                    <p class="mb-4 opacity-80" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">¬°Vota por tu serie favorita!</p>
                    
                    <div class="grid grid-cols-1 gap-4">
                      ${seriesData.map(series => {
                        const voteCount = voteCounts[series.id] || 0;
                        const percentage = totalVotes > 0 ? (voteCount / totalVotes * 100).toFixed(1) : 0;
                        const hasVoted = !!userVote;
                        const isUserChoice = userVote?.series_id === series.id;
                        
                        return `
                          <button 
                            class="text-left p-4 rounded-lg transition-all ${hasVoted ? 'cursor-default' : 'hover:opacity-80'}"
                            style="background-color: rgba(31, 41, 55, 0.6); border: 2px solid ${isUserChoice ? accentColor : 'transparent'}; position: relative; overflow: hidden;"
                            ${hasVoted ? 'disabled' : `onclick="voteSeriesOfMonth('${currentMonth.month_id}', '${series.id}')"`}
                          >
                            ${hasVoted ? `
                              <div class="absolute inset-0 transition-all" style="background: linear-gradient(90deg, ${accentColor}33 ${percentage}%, transparent ${percentage}%);"></div>
                            ` : ''}
                            <div class="relative flex justify-between items-center">
                              <div>
                                <h3 class="font-semibold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                                <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.genre} ‚Ä¢ ${series.country}</p>
                              </div>
                              ${hasVoted ? `
                                <div class="text-right">
                                  <p style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px; color: ${accentColor}; font-weight: 600;">${percentage}%</p>
                                  <p class="text-xs opacity-60" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px;">${voteCount} votos</p>
                                </div>
                              ` : ''}
                            </div>
                          </button>
                        `;
                      }).join('')}
                    </div>
                    <p class="mt-3 text-xs opacity-60 text-right" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px;">
                      Total: ${totalVotes} voto${totalVotes !== 1 ? 's' : ''}
                    </p>
                  </section>
                `;
              }
              return '';
            })()}
            
            <!-- Polls Normales -->
            ${polls.length > 0 ? polls.map(poll => {
              const pollOptions = JSON.parse(poll.poll_options);
              const allVotesForPoll = appState.userData.filter(d => d.type === 'poll_vote' && d.poll_id === poll.poll_id);
              const totalVotes = allVotesForPoll.length;
              const userVote = userVotes.find(v => v.poll_id === poll.poll_id);
              const hasVoted = !!userVote;
              
              // Contar votos por opci√≥n
              const voteCounts = {};
              pollOptions.forEach(opt => voteCounts[opt] = 0);
              allVotesForPoll.forEach(vote => {
                if (voteCounts[vote.user_vote] !== undefined) {
                  voteCounts[vote.user_vote]++;
                }
              });
              
              return `
                <div class="mb-6 p-5 rounded-lg series-card">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">${poll.poll_title}</h3>
                    ${isAdmin ? `
                      <button onclick="deletePoll('${poll.poll_id}')" class="w-8 h-8 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(239, 68, 68, 0.8);">
                        <svg class="w-5 h-5" fill="white" viewBox="0 0 24 24">
                          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                      </button>
                    ` : ''}
                  </div>
                  <div class="space-y-3">
                    ${pollOptions.map(option => {
                      const voteCount = voteCounts[option] || 0;
                      const percentage = totalVotes > 0 ? (voteCount / totalVotes * 100).toFixed(1) : 0;
                      const isUserChoice = userVote?.user_vote === option;
                      
                      return `
                        <button 
                          class="w-full text-left p-3 rounded-lg transition-all ${hasVoted ? 'cursor-default' : 'hover:opacity-80'}"
                          style="background-color: rgba(31, 41, 55, 0.6); border: 2px solid ${isUserChoice ? accentColor : 'transparent'}; position: relative; overflow: hidden;"
                          ${hasVoted ? 'disabled' : `onclick="votePoll('${poll.poll_id}', '${option}')"`}
                        >
                          ${hasVoted ? `
                            <div class="absolute inset-0 transition-all" style="background: linear-gradient(90deg, ${accentColor}33 ${percentage}%, transparent ${percentage}%);"></div>
                          ` : ''}
                          <div class="relative flex justify-between items-center">
                            <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${option}</span>
                            ${hasVoted ? `
                              <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">${percentage}% (${voteCount})</span>
                            ` : ''}
                          </div>
                        </button>
                      `;
                    }).join('')}
                  </div>
                  <p class="mt-3 text-sm opacity-60 text-right" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px;">
                    ${totalVotes} voto${totalVotes !== 1 ? 's' : ''}
                  </p>
                </div>
              `;
            }).join('') : `
              <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="${accentColor}" viewBox="0 0 24 24">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                </svg>
                <p class="opacity-50" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">No hay polls disponibles</p>
              </div>
            `}
          </main>
        </div>
      `;
    }
    
    // Funci√≥n para votar en una poll
    window.votePoll = async function(pollId, option) {
      if (!appState.currentUser || appState.isGuest) return;
      
      const result = await window.dataSdk.create({
        type: 'poll_vote',
        poll_id: pollId,
        user_id: appState.currentUser.id,
        user_vote: option,
        timestamp: Date.now()
      });
      
      if (!result.isOk) {
        console.error('Error voting in poll');
      }
    };
    
    // Funci√≥n para votar en serie del mes
    window.voteSeriesOfMonth = async function(monthId, seriesId) {
      if (!appState.currentUser || appState.isGuest) return;
      
      const result = await window.dataSdk.create({
        type: 'series_month_vote',
        month_id: monthId,
        user_id: appState.currentUser.id,
        series_id: seriesId,
        timestamp: Date.now()
      });
      
      if (!result.isOk) {
        console.error('Error voting for series of the month');
      }
    };
    
    // Funci√≥n principal de renderizado
    async function render() {
      const app = document.getElementById('app');
      
      let html = '';
      switch (appState.currentScreen) {
        case 'splash':
          html = renderSplashScreen();
          break;
        case 'login':
          html = renderLoginScreen();
          break;
        case 'home':
          html = renderHomeScreen();
          break;
        case 'series':
          html = renderSeriesScreen();
          break;
        case 'profile':
          html = renderProfileScreen();
          break;
        case 'polls':
          html = renderPollsScreen();
          break;
      }
      
      app.innerHTML = html;
      attachEventListeners();
    }
    
    // Adjuntar event listeners
    function attachEventListeners() {
      // Login form
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          
          const submitBtn = loginForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Iniciando...';
          
          try {
            const { signInWithEmailAndPassword } = window.firebaseAuthFunctions;
            const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
            const user = userCredential.user;
            
            appState.currentUser = {
              id: user.uid,
              email: user.email,
              username: user.displayName || user.email.split('@')[0]
            };
            
            // Cargar perfil del usuario
            const profile = getUserProfile(user.uid);
            if (profile) {
              appState.userProfile = profile;
            }
            
            appState.currentScreen = 'home';
            await render();
          } catch (error) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            
            let errorMessage = 'Error al iniciar sesi√≥n';
            if (error.code === 'auth/invalid-credential') {
              errorMessage = 'Correo o contrase√±a incorrectos';
            } else if (error.code === 'auth/user-not-found') {
              errorMessage = 'Usuario no encontrado';
            } else if (error.code === 'auth/wrong-password') {
              errorMessage = 'Contrase√±a incorrecta';
            } else if (error.code === 'auth/invalid-email') {
              errorMessage = 'Correo inv√°lido';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mt-4 p-3 rounded-lg text-center';
            errorDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
            errorDiv.style.color = '#ef4444';
            errorDiv.textContent = errorMessage;
            loginForm.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 3000);
          }
        });
      }
      
      // Signup button
      const signupBtn = document.getElementById('signupBtn');
      if (signupBtn) {
        signupBtn.addEventListener('click', async () => {
          const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
          const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
          const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
          modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
          modal.innerHTML = `
            <div class="w-full max-w-md p-6 rounded-lg fade-in" style="background-color: #1f2937;">
              <h2 class="mb-4 font-bold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px;">Crear Cuenta</h2>
              <form id="signupForm" class="space-y-4">
                <div>
                  <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Nombre de Usuario</label>
                  <input 
                    type="text" 
                    id="signupUsername" 
                    required
                    class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                    style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  />
                </div>
                <div>
                  <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Correo</label>
                  <input 
                    type="email" 
                    id="signupEmail" 
                    required
                    class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                    style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  />
                </div>
                <div>
                  <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Contrase√±a (m√≠nimo 6 caracteres)</label>
                  <input 
                    type="password" 
                    id="signupPassword" 
                    required
                    minlength="6"
                    class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                    style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  />
                </div>
                <div class="flex gap-3">
                  <button type="submit" class="flex-1 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;">
                    Crear
                  </button>
                  <button type="button" id="cancelSignup" class="flex-1 py-3 rounded-lg transition-all hover:opacity-70" style="border: 2px solid rgba(255, 255, 255, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">
                    Cancelar
                  </button>
                </div>
              </form>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          document.getElementById('cancelSignup').addEventListener('click', () => {
            modal.remove();
          });
          
          document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creando...';
            
            try {
              const { createUserWithEmailAndPassword, updateProfile } = window.firebaseAuthFunctions;
              const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
              const user = userCredential.user;
              
              await updateProfile(user, {
                displayName: username
              });
              
              appState.currentUser = {
                id: user.uid,
                email: user.email,
                username: username
              };
              
              // Crear perfil inicial del usuario
              await window.dataSdk.create({
                type: 'user_profile',
                user_id: user.uid,
                username: username,
                email: user.email,
                profile_picture: 'avatar-bad-buddy',
                community_name: ''
              });
              
              modal.remove();
              appState.currentScreen = 'home';
              await render();
            } catch (error) {
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
              
              let errorMessage = 'Error al crear la cuenta';
              if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'Este correo ya est√° en uso';
              } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Correo inv√°lido';
              } else if (error.code === 'auth/weak-password') {
                errorMessage = 'La contrase√±a debe tener al menos 6 caracteres';
              }
              
              const existingError = modal.querySelector('.error-message');
              if (existingError) existingError.remove();
              
              const errorDiv = document.createElement('div');
              errorDiv.className = 'error-message mt-3 p-3 rounded-lg text-center';
              errorDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
              errorDiv.style.color = '#ef4444';
              errorDiv.style.fontFamily = customFont;
              errorDiv.style.fontSize = baseFontSize * 0.875 + 'px';
              errorDiv.textContent = errorMessage;
              e.target.appendChild(errorDiv);
              
              setTimeout(() => errorDiv.remove(), 3000);
            }
          });
        });
      }
      
      // Guest button
      const guestBtn = document.getElementById('guestBtn');
      if (guestBtn) {
        guestBtn.addEventListener('click', async () => {
          appState.isGuest = true;
          appState.currentScreen = 'home';
          await render();
        });
      }
      
      // Profile button
      const profileBtn = document.getElementById('profileBtn');
      if (profileBtn) {
        profileBtn.addEventListener('click', async () => {
          appState.currentScreen = 'profile';
          await render();
        });
      }
      
      // Polls button
      const pollsBtn = document.getElementById('pollsBtn');
      if (pollsBtn) {
        pollsBtn.addEventListener('click', async () => {
          appState.hasUnreadPoll = false; // Marcar como le√≠do
          appState.currentScreen = 'polls';
          await render();
        });
      }
      
      // Back to home
      const backToHomeBtn = document.getElementById('backToHomeBtn');
      if (backToHomeBtn) {
        backToHomeBtn.addEventListener('click', async () => {
          appState.currentScreen = 'home';
          await render();
        });
      }
      
      // Back to home from polls
      const backToHomeFromPolls = document.getElementById('backToHomeFromPolls');
      if (backToHomeFromPolls) {
        backToHomeFromPolls.addEventListener('click', async () => {
          appState.currentScreen = 'home';
          await render();
        });
      }
      
      // Go to login
      const goToLoginBtn = document.getElementById('goToLoginBtn');
      if (goToLoginBtn) {
        goToLoginBtn.addEventListener('click', async () => {
          appState.currentScreen = 'login';
          await render();
        });
      }
      
      // Edit profile button
      const editProfileBtn = document.getElementById('editProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.addEventListener('click', () => {
          showEditProfileModal();
        });
      }
      
      // Change avatar button
      const changeAvatarBtn = document.getElementById('changeAvatarBtn');
      if (changeAvatarBtn) {
        changeAvatarBtn.addEventListener('click', () => {
          showAvatarModal();
        });
      }
      
      // Create poll button
      const createPollBtn = document.getElementById('createPollBtn');
      if (createPollBtn) {
        createPollBtn.addEventListener('click', () => {
          showCreatePollModal();
        });
      }
      
      // Series of month button
      const seriesOfMonthBtn = document.getElementById('seriesOfMonthBtn');
      if (seriesOfMonthBtn) {
        seriesOfMonthBtn.addEventListener('click', () => {
          showSeriesOfMonthModal();
        });
      }
      
      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            const { signOut } = window.firebaseAuthFunctions;
            await signOut(window.firebaseAuth);
            
            appState.currentUser = null;
            appState.userProfile = null;
            appState.isGuest = false;
            appState.currentScreen = 'login';
            await render();
          } catch (error) {
            console.error('Error al cerrar sesi√≥n:', error);
          }
        });
      }
      
      // Series cards
      const seriesCards = document.querySelectorAll('[data-series-id]');
      seriesCards.forEach(card => {
        card.addEventListener('click', async () => {
          const seriesId = card.dataset.seriesId;
          appState.selectedSeries = seriesDatabase.find(s => s.id === seriesId);
          appState.currentScreen = 'series';
          await render();
        });
      });
      
      // Back button
      const backBtn = document.getElementById('backBtn');
      if (backBtn) {
        backBtn.addEventListener('click', async () => {
          appState.currentScreen = 'home';
          appState.selectedSeries = null;
          await render();
        });
      }
      
      // Episode toggle
      const eyeToggles = document.querySelectorAll('.eye-toggle');
      eyeToggles.forEach(toggle => {
        toggle.addEventListener('click', async () => {
          if (!appState.currentUser || appState.isGuest) return;
          
          const episode = parseInt(toggle.dataset.episode);
          const existingRecord = appState.userData.find(d => 
            d.type === 'episode' && 
            d.series_id === appState.selectedSeries.id && 
            d.user_id === appState.currentUser.id &&
            d.episode_number === episode
          );
          
          toggle.disabled = true;
          
          if (existingRecord) {
            const updated = { ...existingRecord, watched: !existingRecord.watched };
            const result = await window.dataSdk.update(updated);
            if (!result.isOk) {
              console.error('Error updating episode');
            }
          } else {
            const result = await window.dataSdk.create({
              type: 'episode',
              user_id: appState.currentUser.id,
              series_id: appState.selectedSeries.id,
              episode_number: episode,
              watched: true
            });
            if (!result.isOk) {
              console.error('Error creating episode record');
            }
          }
          
          toggle.disabled = false;
        });
      });
      
      // Rating
      const starRatings = document.querySelectorAll('.star-rating');
      starRatings.forEach(star => {
        star.addEventListener('click', async () => {
          if (!appState.currentUser || appState.isGuest) return;
          
          const rating = parseInt(star.dataset.rating);
          const existingRating = appState.userData.find(d => 
            d.type === 'rating' && 
            d.series_id === appState.selectedSeries.id && 
            d.user_id === appState.currentUser.id
          );
          
          star.disabled = true;
          
          if (existingRating) {
            const updated = { ...existingRating, rating };
            const result = await window.dataSdk.update(updated);
            if (!result.isOk) {
              console.error('Error updating rating');
            }
          } else {
            const result = await window.dataSdk.create({
              type: 'rating',
              user_id: appState.currentUser.id,
              series_id: appState.selectedSeries.id,
              rating
            });
            if (!result.isOk) {
              console.error('Error creating rating');
            }
          }
          
          star.disabled = false;
        });
      });
      
      // Chat form
      const chatForm = document.getElementById('chatForm');
      if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!appState.currentUser || appState.isGuest) return;
          
          const input = document.getElementById('chatInput');
          const message = input.value.trim();
          if (!message) return;
          
          const submitBtn = chatForm.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          input.disabled = true;
          
          const result = await window.dataSdk.create({
            type: 'message',
            user_id: appState.currentUser.id,
            series_id: appState.selectedSeries.id,
            username: appState.currentUser.username,
            message,
            timestamp: Date.now()
          });
          
          if (result.isOk) {
            input.value = '';
          } else {
            console.error('Error sending message');
          }
          
          submitBtn.disabled = false;
          input.disabled = false;
        });
      }
    }
    
    // Mostrar modal de edici√≥n de perfil
    function showEditProfileModal() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      modal.innerHTML = `
        <div class="w-full max-w-md p-6 rounded-lg fade-in" style="background-color: #1f2937;">
          <h2 class="mb-4 font-bold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px;">Editar Perfil</h2>
          <form id="editProfileForm" class="space-y-4">
            <div>
              <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Nombre de Usuario</label>
              <input 
                type="text" 
                id="editUsername" 
                value="${appState.currentUser.username}"
                required
                class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
              />
            </div>
            <div>
              <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Nombre para Comunidad</label>
              <input 
                type="text" 
                id="editCommunityName" 
                value="${appState.userProfile?.community_name || ''}"
                placeholder="ohmnanonforever"
                class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
              />
            </div>
            <p class="text-sm opacity-60" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px;">Correo: ${appState.currentUser.email} (no se puede cambiar)</p>
            <div class="flex gap-3">
              <button type="submit" class="flex-1 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;">
                Guardar
              </button>
              <button type="button" id="cancelEdit" class="flex-1 py-3 rounded-lg transition-all hover:opacity-70" style="border: 2px solid rgba(255, 255, 255, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelEdit').addEventListener('click', () => {
        modal.remove();
      });
      
      document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newUsername = document.getElementById('editUsername').value.trim();
        const newCommunityName = document.getElementById('editCommunityName').value.trim();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';
        
        try {
          // Actualizar Firebase Auth
          const { updateProfile } = window.firebaseAuthFunctions;
          await updateProfile(window.firebaseAuth.currentUser, {
            displayName: newUsername
          });
          
          // Actualizar perfil en Data SDK
          if (appState.userProfile && appState.userProfile.__backendId) {
            const updated = {
              ...appState.userProfile,
              username: newUsername,
              community_name: newCommunityName
            };
            const result = await window.dataSdk.update(updated);
            if (result.isOk) {
              appState.currentUser.username = newUsername;
              modal.remove();
            } else {
              console.error('Error updating profile:', result.error);
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } else {
            // Crear perfil si no existe
            const result = await window.dataSdk.create({
              type: 'user_profile',
              user_id: appState.currentUser.id,
              username: newUsername,
              email: appState.currentUser.email,
              profile_picture: 'avatar-bad-buddy',
              community_name: newCommunityName
            });
            
            if (result.isOk) {
              appState.currentUser.username = newUsername;
              modal.remove();
            } else {
              console.error('Error creating profile:', result.error);
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          }
        } catch (error) {
          console.error('Error updating profile:', error);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
    
    // Mostrar modal de selecci√≥n de avatar
    function showAvatarModal() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      
      const currentAvatar = appState.userProfile?.profile_picture || 'avatar-bad-buddy';
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      modal.innerHTML = `
        <div class="w-full max-w-2xl p-6 rounded-lg fade-in overflow-y-auto" style="background-color: #1f2937; max-height: 80%;">
          <h2 class="mb-6 font-bold text-center" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px;">Elige tu Avatar</h2>
          
          <div class="grid grid-cols-3 gap-6 mb-6">
            ${avatarLibrary.map(avatar => {
              const isSelected = currentAvatar === `avatar-${avatar.id}`;
              return `
                <div class="text-center">
                  <button 
                    class="avatar-option w-20 h-20 rounded-full mx-auto mb-2 flex items-center justify-center ${isSelected ? 'selected' : ''}"
                    data-avatar-id="${avatar.id}"
                    style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 2.5}px;"
                  >
                    ${avatar.emoji}
                  </button>
                  <p class="text-xs" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px; opacity: 0.8;">${avatar.series}</p>
                </div>
              `;
            }).join('')}
          </div>
          
          <div class="flex gap-3">
            <button id="saveAvatar" class="flex-1 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;">
              Guardar
            </button>
            <button id="cancelAvatar" class="flex-1 py-3 rounded-lg transition-all hover:opacity-70" style="border: 2px solid rgba(255, 255, 255, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      let selectedAvatarId = currentAvatar.replace('avatar-', '');
      
      // Avatar selection
      modal.querySelectorAll('.avatar-option').forEach(btn => {
        btn.addEventListener('click', () => {
          modal.querySelectorAll('.avatar-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedAvatarId = btn.dataset.avatarId;
        });
      });
      
      document.getElementById('cancelAvatar').addEventListener('click', () => {
        modal.remove();
      });
      
      document.getElementById('saveAvatar').addEventListener('click', async () => {
        const saveBtn = document.getElementById('saveAvatar');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';
        
        const newPicture = `avatar-${selectedAvatarId}`;
        
        if (appState.userProfile && appState.userProfile.__backendId) {
          const updated = {
            ...appState.userProfile,
            profile_picture: newPicture
          };
          const result = await window.dataSdk.update(updated);
          if (result.isOk) {
            modal.remove();
          } else {
            console.error('Error updating avatar:', result.error);
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
          }
        } else {
          const result = await window.dataSdk.create({
            type: 'user_profile',
            user_id: appState.currentUser.id,
            username: appState.currentUser.username,
            email: appState.currentUser.email,
            profile_picture: newPicture,
            community_name: ''
          });
          
          if (result.isOk) {
            modal.remove();
          } else {
            console.error('Error creating profile:', result.error);
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
          }
        }
      });
    }
    
    // Mostrar modal de creaci√≥n de poll
    function showCreatePollModal() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      modal.innerHTML = `
        <div class="w-full max-w-md p-6 rounded-lg fade-in overflow-y-auto" style="background-color: #1f2937; max-height: 80%;">
          <h2 class="mb-4 font-bold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px;">Crear Poll</h2>
          <form id="createPollForm" class="space-y-4">
            <div>
              <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">T√≠tulo de la Poll</label>
              <input 
                type="text" 
                id="pollTitle" 
                required
                placeholder="ÔøΩÔøΩCu√°l es tu serie favorita?"
                class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
              />
            </div>
            
            <div>
              <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Opciones (una por l√≠nea)</label>
              <textarea 
                id="pollOptions" 
                required
                rows="6"
                placeholder="Bad Buddy&#10;Semantic Error&#10;GAP&#10;Cherry Magic"
                class="w-full px-4 py-3 rounded-lg input-glow transition-all resize-none" 
                style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
              ></textarea>
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="flex-1 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;">
                Crear Poll
              </button>
              <button type="button" id="cancelPoll" class="flex-1 py-3 rounded-lg transition-all hover:opacity-70" style="border: 2px solid rgba(255, 255, 255, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('cancelPoll').addEventListener('click', () => {
        modal.remove();
      });
      
      document.getElementById('createPollForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('pollTitle').value.trim();
        const optionsText = document.getElementById('pollOptions').value.trim();
        const options = optionsText.split('\n').filter(o => o.trim()).map(o => o.trim());
        
        if (options.length < 2) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'mt-3 p-3 rounded-lg text-center';
          errorDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
          errorDiv.style.color = '#ef4444';
          errorDiv.textContent = 'Debes agregar al menos 2 opciones';
          modal.querySelector('form').appendChild(errorDiv);
          setTimeout(() => errorDiv.remove(), 3000);
          return;
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando...';
        
        const pollId = `poll-${Date.now()}`;
        const result = await window.dataSdk.create({
          type: 'poll',
          poll_id: pollId,
          poll_title: title,
          poll_options: JSON.stringify(options),
          poll_creator: appState.currentUser.email,
          timestamp: Date.now()
        });
        
        if (result.isOk) {
          modal.remove();
          await render();
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear Poll';
        }
      });
    }
    
    // Mostrar modal de creaci√≥n de serie del mes
    function showSeriesOfMonthModal() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      modal.innerHTML = `
        <div class="w-full max-w-md p-6 rounded-lg fade-in overflow-y-auto" style="background-color: #1f2937; max-height: 80%;">
          <h2 class="mb-4 font-bold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px;">‚≠ê Crear Serie del Mes</h2>
          <p class="mb-4 opacity-80" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Selecciona 3 series para que la comunidad vote</p>
          
          <form id="seriesOfMonthForm" class="space-y-4">
            <div>
              <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Selecciona 3 Series</label>
              <div class="space-y-2 max-h-80 overflow-y-auto p-3 rounded-lg" style="background-color: rgba(31, 41, 55, 0.4);">
                ${seriesDatabase.map(series => `
                  <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.6);">
                    <input 
                      type="checkbox" 
                      name="series" 
                      value="${series.id}"
                      class="w-5 h-5 rounded"
                      style="accent-color: ${accentColor};"
                    />
                    <div class="flex-1">
                      <p class="font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.title}</p>
                      <p class="text-xs opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.75}px;">${series.genre} ‚Ä¢ ${series.country}</p>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="flex-1 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90" style="background: linear-gradient(135deg, #a855f7, #ec4899); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;">
                Crear Serie del Mes
              </button>
              <button type="button" id="cancelSeriesMonth" class="flex-1 py-3 rounded-lg transition-all hover:opacity-70" style="border: 2px solid rgba(255, 255, 255, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Limitar selecci√≥n a 3
      const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const checked = modal.querySelectorAll('input[type="checkbox"]:checked');
          if (checked.length > 3) {
            checkbox.checked = false;
          }
        });
      });
      
      document.getElementById('cancelSeriesMonth').addEventListener('click', () => {
        modal.remove();
      });
      
      document.getElementById('seriesOfMonthForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const checked = modal.querySelectorAll('input[type="checkbox"]:checked');
        
        if (checked.length !== 3) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'mt-3 p-3 rounded-lg text-center';
          errorDiv.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
          errorDiv.style.color = '#ef4444';
          errorDiv.textContent = 'Debes seleccionar exactamente 3 series';
          modal.querySelector('form').appendChild(errorDiv);
          setTimeout(() => errorDiv.remove(), 3000);
          return;
        }
        
        const seriesIds = Array.from(checked).map(c => c.value);
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando...';
        
        const monthId = `month-${Date.now()}`;
        const result = await window.dataSdk.create({
          type: 'series_of_month',
          month_id: monthId,
          series_ids: JSON.stringify(seriesIds),
          creator: appState.currentUser.email,
          timestamp: Date.now()
        });
        
        if (result.isOk) {
          modal.remove();
          await render();
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear Serie del Mes';
        }
      });
    }
    
    // Funci√≥n para borrar poll (solo admins)
    window.deletePoll = async function(pollId) {
      if (!ADMIN_EMAILS.includes(appState.currentUser?.email)) return;
      
      // Encontrar el record de la poll
      const pollRecord = appState.userData.find(d => d.type === 'poll' && d.poll_id === pollId);
      if (!pollRecord) return;
      
      // Confirmar borrado
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
      confirmDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      confirmDiv.innerHTML = `
        <div class="w-full max-w-sm p-6 rounded-lg fade-in text-center" style="background-color: #1f2937;">
          <p class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">¬øBorrar esta poll?</p>
          <div class="flex gap-3">
            <button id="confirmDeletePoll" class="flex-1 py-2 rounded-lg" style="background-color: #ef4444; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
              Borrar
            </button>
            <button id="cancelDeletePoll" class="flex-1 py-2 rounded-lg" style="background-color: rgba(255, 255, 255, 0.1); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);
      
      document.getElementById('cancelDeletePoll').addEventListener('click', () => {
        confirmDiv.remove();
      });
      
      document.getElementById('confirmDeletePoll').addEventListener('click', async () => {
        const result = await window.dataSdk.delete(pollRecord);
        if (result.isOk) {
          // Borrar tambi√©n todos los votos de esta poll
          const votes = appState.userData.filter(d => d.type === 'poll_vote' && d.poll_id === pollId);
          for (const vote of votes) {
            await window.dataSdk.delete(vote);
          }
        }
        confirmDiv.remove();
      });
    };
    
    // Funci√≥n para borrar serie del mes (solo admins)
    window.deleteSeriesOfMonth = async function(monthId) {
      if (!ADMIN_EMAILS.includes(appState.currentUser?.email)) return;
      
      // Encontrar el record
      const monthRecord = appState.userData.find(d => d.type === 'series_of_month' && d.month_id === monthId);
      if (!monthRecord) return;
      
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 flex items-center justify-center z-50 px-6';
      confirmDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      confirmDiv.innerHTML = `
        <div class="w-full max-w-sm p-6 rounded-lg fade-in text-center" style="background-color: #1f2937;">
          <p class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">¬øBorrar Serie del Mes?</p>
          <div class="flex gap-3">
            <button id="confirmDeleteMonth" class="flex-1 py-2 rounded-lg" style="background-color: #ef4444; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
              Borrar
            </button>
            <button id="cancelDeleteMonth" class="flex-1 py-2 rounded-lg" style="background-color: rgba(255, 255, 255, 0.1); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);
      
      document.getElementById('cancelDeleteMonth').addEventListener('click', () => {
        confirmDiv.remove();
      });
      
      document.getElementById('confirmDeleteMonth').addEventListener('click', async () => {
        const result = await window.dataSdk.delete(monthRecord);
        if (result.isOk) {
          // Borrar tambi√©n todos los votos de este mes
          const votes = appState.userData.filter(d => d.type === 'series_month_vote' && d.month_id === monthId);
          for (const vote of votes) {
            await window.dataSdk.delete(vote);
          }
        }
        confirmDiv.remove();
      });
    };
    
    // Funci√≥n onConfigChange para actualizar la UI seg√∫n la configuraci√≥n
    async function onConfigChange(config) {
      await render();
    }
    
    // Inicializaci√≥n
    async function init() {
      // Inicializar Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.card_color || defaultConfig.card_color,
                set: (value) => {
                  config.card_color = value;
                  window.elementSdk.setConfig({ card_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  config.accent_color = value;
                  window.elementSdk.setConfig({ accent_color: value });
                }
              },
              {
                get: () => config.secondary_accent || defaultConfig.secondary_accent,
                set: (value) => {
                  config.secondary_accent = value;
                  window.elementSdk.setConfig({ secondary_accent: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_name', config.app_name || defaultConfig.app_name],
            ['tagline', config.tagline || defaultConfig.tagline],
            ['popular_title', config.popular_title || defaultConfig.popular_title],
            ['bl_title', config.bl_title || defaultConfig.bl_title],
            ['gl_title', config.gl_title || defaultConfig.gl_title],
            ['login_button', config.login_button || defaultConfig.login_button],
            ['signup_button', config.signup_button || defaultConfig.signup_button],
            ['guest_button', config.guest_button || defaultConfig.guest_button]
          ])
        });
      }
      
      // Inicializar Data SDK
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error('Error initializing data SDK');
        }
      }
      
      // Mostrar splash screen
      await render();
      
      // Detectar si el usuario ya est√° autenticado
      if (window.firebaseAuth && window.firebaseAuthFunctions) {
        const { onAuthStateChanged } = window.firebaseAuthFunctions;
        onAuthStateChanged(window.firebaseAuth, async (user) => {
          if (user && appState.currentScreen === 'splash') {
            appState.currentUser = {
              id: user.uid,
              email: user.email,
              username: user.displayName || user.email.split('@')[0]
            };
            
            // Cargar perfil
            const profile = getUserProfile(user.uid);
            if (profile) {
              appState.userProfile = profile;
            }
            
            appState.currentScreen = 'home';
            await render();
          } else if (!user && appState.currentScreen === 'splash') {
            setTimeout(async () => {
              appState.currentScreen = 'login';
              await render();
            }, 2000);
          }
        });
      } else {
        setTimeout(async () => {
          appState.currentScreen = 'login';
          await render();
        }, 2000);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b5e4d95d0971a50',t:'MTc2NzA2Mzc5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
