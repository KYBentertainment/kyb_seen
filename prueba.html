<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KYB seen</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBcjjoLZ3XU3SD8xgT6XmvZEVrmoV34A4M",
      authDomain: "kyb-seen.firebaseapp.com",
      projectId: "kyb-seen",
      storageBucket: "kyb-seen.firebasestorage.app",
      messagingSenderId: "916013840344",
      appId: "1:916013840344:web:561274a6db9470a7ca64ad",
      measurementId: "G-1C8ZDYR1JS"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    
    window.firebaseAuth = auth;
    window.firebaseStorage = storage;
    window.firebaseAuthFunctions = {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      updateProfile
    };
    window.firebaseStorageFunctions = {
      ref,
      uploadBytes,
      getDownloadURL
    };
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .fade-in {
      animation: fadeIn 1.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite;
    }
    
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.6); }
    }
    
    .hover-zoom {
      transition: transform 0.3s ease;
    }
    
    .hover-zoom:hover {
      transform: scale(1.05);
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .ripple:active::after {
      width: 300px;
      height: 300px;
    }
    
    .input-glow:focus {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
      border-color: #10b981;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #10b981, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .series-card {
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
      backdrop-filter: blur(10px);
    }
    
    .parallax-header {
      background-size: cover;
      background-position: center;
      transition: transform 0.3s ease-out;
    }
    
    .chat-bubble {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .star-rating {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .star-rating:hover {
      transform: scale(1.2);
    }
    
    .loader {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(16, 185, 129, 0.2);
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .eye-icon {
      transition: all 0.3s ease;
    }
    
    .eye-icon.watched {
      color: #10b981;
      transform: scale(1.1);
    }
    
    .smooth-scroll {
      scroll-behavior: smooth;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1f2937;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #10b981;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #059669;
    }
    
    .notification-dot {
      width: 8px;
      height: 8px;
      background-color: #ef4444;
      border-radius: 50%;
      position: absolute;
      top: 8px;
      right: 8px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .avatar-option {
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }
    
    .avatar-option:hover {
      transform: scale(1.1);
    }
    
    .avatar-option.selected {
      border-color: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }
    
    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    
    .toast {
      animation: toastSlide 0.3s ease-out;
    }
    
    @keyframes toastSlide {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .desktop-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    @media (min-width: 768px) {
      .desktop-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      .desktop-layout {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 2rem;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-900 text-white overflow-auto">
  <div id="app" class="h-full w-full"></div>
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <script>
    const defaultConfig = {
      app_name: "KYB seen",
      tagline: "Tu comunidad BL/GL",
      popular_title: "Popular",
      bl_title: "BL",
      gl_title: "GL",
      background_color: "#111827",
      card_color: "#1f2937",
      text_color: "#ffffff",
      accent_color: "#10b981",
      secondary_accent: "#ec4899",
      login_button: "Iniciar Sesi√≥n",
      signup_button: "Crear Cuenta",
      guest_button: "Entrar como Invitado",
      font_family: "Inter",
      font_size: 16
    };
    
    const ADMIN_EMAILS = ['soportedekyb@gmail.com', 'elihuf07@gmail.com'];
    
    let appState = {
      currentScreen: 'splash',
      currentUser: null,
      userProfile: null,
      isGuest: false,
      selectedSeries: null,
      userData: [],
      hasUnreadPoll: false,
      isLoading: false,
      recordCount: 0
    };
    
    const avatarLibrary = [
      { id: 'bad-buddy', series: 'Bad Buddy', url: 'https://via.placeholder.com/150/ec4899/ffffff?text=BB' },
      { id: 'semantic-error', series: 'Semantic Error', url: 'https://via.placeholder.com/150/8b5cf6/ffffff?text=SE' },
      { id: 'gap', series: 'GAP', url: 'https://via.placeholder.com/150/10b981/ffffff?text=GAP' },
      { id: 'cherry-magic', series: 'Cherry Magic', url: 'https://via.placeholder.com/150/f59e0b/ffffff?text=CM' },
      { id: 'we-best-love', series: 'We Best Love', url: 'https://via.placeholder.com/150/ef4444/ffffff?text=WBL' },
      { id: 'handmaiden', series: 'Handmaiden', url: 'https://via.placeholder.com/150/ec4899/ffffff?text=HM' },
      { id: 'gameboys', series: 'Gameboys', url: 'https://via.placeholder.com/150/3b82f6/ffffff?text=GB' },
      { id: 'tsukutabe', series: 'Tsukutabe', url: 'https://via.placeholder.com/150/06b6d4/ffffff?text=TT' },
      { id: 'love-stage', series: 'Love Stage', url: 'https://via.placeholder.com/150/a855f7/ffffff?text=LS' },
      { id: 'bl-drama', series: 'BL Drama', url: 'https://via.placeholder.com/150/f472b6/ffffff?text=BD' },
      { id: 'gl-series', series: 'GL Series', url: 'https://via.placeholder.com/150/c084fc/ffffff?text=GL' },
      { id: 'my-school', series: 'My School', url: 'https://via.placeholder.com/150/14b8a6/ffffff?text=MS' }
    ];
    
    const seriesDatabase = [
      { id: 'bl-thailand-1', title: 'Bad Buddy', country: 'Thailand', genre: 'BL', year: 2021, episodes: 12, duration: '45 min', synopsis: 'Pat y Pran han sido rivales desde la infancia debido a sus familias. Pero cuando se hacen vecinos en la universidad, descubren que hay algo m√°s que rivalidad entre ellos.', poster: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Bad+Buddy', rating: 0, ratingCount: 0, category: 'popular' },
      { id: 'bl-korea-1', title: 'Semantic Error', country: 'Korea', genre: 'BL', year: 2022, episodes: 8, duration: '25 min', synopsis: 'Chu Sangwoo es un estudiante de inform√°tica perfeccionista que se ve obligado a trabajar con Jang Jaeyoung, un artista carism√°tico y ca√≥tico.', poster: 'https://via.placeholder.com/300x450/8b5cf6/ffffff?text=Semantic+Error', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'gl-thailand-1', title: 'GAP The Series', country: 'Thailand', genre: 'GL', year: 2022, episodes: 12, duration: '50 min', synopsis: 'Mon, una joven trabajadora, se enamora de su jefa Sam, una heredera fr√≠a y distante. Una historia de amor prohibido en el mundo corporativo.', poster: 'https://via.placeholder.com/300x450/10b981/ffffff?text=GAP', rating: 0, ratingCount: 0, category: 'popular' },
      { id: 'bl-japan-1', title: 'Cherry Magic', country: 'Japan', genre: 'BL', year: 2020, episodes: 12, duration: '30 min', synopsis: 'Adachi descubre que al cumplir 30 a√±os siendo virgen, puede leer las mentes de las personas que toca. Descubre que su compa√±ero Kurosawa est√° enamorado de √©l.', poster: 'https://via.placeholder.com/300x450/f59e0b/ffffff?text=Cherry+Magic', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'bl-taiwan-1', title: 'We Best Love', country: 'Taiwan', genre: 'BL', year: 2021, episodes: 12, duration: '35 min', synopsis: 'Zhou Shuyi y Gao Shide han sido rivales durante a√±os, pero sus sentimientos van m√°s all√° de la competencia acad√©mica.', poster: 'https://via.placeholder.com/300x450/ef4444/ffffff?text=We+Best+Love', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'gl-korea-1', title: 'The Handmaiden', country: 'Korea', genre: 'GL', year: 2023, episodes: 10, duration: '40 min', synopsis: 'Una adaptaci√≥n moderna de una historia de amor entre dos mujeres de diferentes clases sociales.', poster: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Handmaiden', rating: 0, ratingCount: 0, category: 'gl' },
      { id: 'bl-philippines-1', title: 'Gameboys', country: 'Philippines', genre: 'BL', year: 2020, episodes: 13, duration: '20 min', synopsis: 'Durante la cuarentena, Cairo conoce a Gavreel en un videojuego. Lo que comienza como amistad virtual se convierte en algo m√°s profundo.', poster: 'https://via.placeholder.com/300x450/3b82f6/ffffff?text=Gameboys', rating: 0, ratingCount: 0, category: 'popular' },
      { id: 'gl-japan-1', title: 'Tsukutabe', country: 'Japan', genre: 'GL', year: 2023, episodes: 10, duration: '30 min', synopsis: 'Una historia sobre comida, amor y autodescubrimiento entre dos mujeres que comparten su pasi√≥n por la cocina.', poster: 'https://via.placeholder.com/300x450/06b6d4/ffffff?text=Tsukutabe', rating: 0, ratingCount: 0, category: 'gl' },
      { id: 'bl-thailand-2', title: 'KinnPorsche', country: 'Thailand', genre: 'BL', year: 2022, episodes: 14, duration: '50 min', synopsis: 'Kinn, el segundo hijo de una familia mafiosa, se enamora de Porsche, quien se convierte en su guardaespaldas.', poster: 'https://via.placeholder.com/300x450/dc2626/ffffff?text=KinnPorsche', rating: 0, ratingCount: 0, category: 'popular' },
      { id: 'bl-korea-2', title: 'Love Class', country: 'Korea', genre: 'BL', year: 2022, episodes: 6, duration: '25 min', synopsis: 'Estudiantes universitarios exploran el amor mientras toman una clase sobre relaciones.', poster: 'https://via.placeholder.com/300x450/7c3aed/ffffff?text=Love+Class', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'bl-japan-2', title: 'Old Fashion Cupcake', country: 'Japan', genre: 'BL', year: 2022, episodes: 5, duration: '25 min', synopsis: 'Un jefe y su subordinado descubren nuevos sentimientos mientras visitan caf√©s de postres.', poster: 'https://via.placeholder.com/300x450/f97316/ffffff?text=Old+Fashion', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'gl-thailand-2', title: 'Show Me Love', country: 'Thailand', genre: 'GL', year: 2023, episodes: 9, duration: '45 min', synopsis: 'Una influencer y una estudiante de medicina se enamoran en medio de las redes sociales.', poster: 'https://via.placeholder.com/300x450/06b6d4/ffffff?text=Show+Me+Love', rating: 0, ratingCount: 0, category: 'gl' },
      { id: 'bl-taiwan-2', title: 'History 3: MODC', country: 'Taiwan', genre: 'BL', year: 2019, episodes: 20, duration: '30 min', synopsis: 'Un polic√≠a puede ver fantasmas y un joven que acaba de morir forman un v√≠nculo inesperado.', poster: 'https://via.placeholder.com/300x450/0891b2/ffffff?text=MODC', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'gl-korea-2', title: 'Lily Fever', country: 'Korea', genre: 'GL', year: 2023, episodes: 8, duration: '15 min', synopsis: 'Dos estudiantes universitarias exploran sus sentimientos en esta dulce historia de primer amor.', poster: 'https://via.placeholder.com/300x450/db2777/ffffff?text=Lily+Fever', rating: 0, ratingCount: 0, category: 'gl' },
      { id: 'bl-thailand-3', title: 'My School President', country: 'Thailand', genre: 'BL', year: 2023, episodes: 12, duration: '45 min', synopsis: 'Gun quiere que su banda gane la competencia escolar, pero Tinn, el presidente estudiantil, tiene otros planes.', poster: 'https://via.placeholder.com/300x450/14b8a6/ffffff?text=My+School', rating: 0, ratingCount: 0, category: 'popular' },
      { id: 'bl-japan-3', title: 'My Beautiful Man', country: 'Japan', genre: 'BL', year: 2021, episodes: 6, duration: '25 min', synopsis: 'Hira, un estudiante t√≠mido, idolatra a Kiyoi, el chico popular de la clase.', poster: 'https://via.placeholder.com/300x450/84cc16/ffffff?text=Beautiful+Man', rating: 0, ratingCount: 0, category: 'bl' },
      { id: 'gl-japan-2', title: 'Whisper Me a Love Song', country: 'Japan', genre: 'GL', year: 2024, episodes: 12, duration: '25 min', synopsis: 'Una chica se enamora de una cantante despu√©s de escuchar su m√∫sica.', poster: 'https://via.placeholder.com/300x450/f43f5e/ffffff?text=Whisper+Love', rating: 0, ratingCount: 0, category: 'gl' }
    ];
    
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
      };
      
      toast.className = 'toast px-6 py-3 rounded-lg shadow-lg';
      toast.style.backgroundColor = colors[type] || colors.info;
      toast.style.color = 'white';
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    const dataHandler = {
      onDataChanged(data) {
        appState.userData = data;
        appState.recordCount = data.length;
        
        if (appState.currentUser && !appState.isGuest) {
          const profile = data.find(d => d.type === 'user_profile' && d.user_id === appState.currentUser.id);
          if (profile) {
            appState.userProfile = profile;
          }
        }
        
        const polls = data.filter(d => d.type === 'poll');
        const userVotes = data.filter(d => d.type === 'poll_vote' && d.user_id === appState.currentUser?.id);
        const votedPollIds = userVotes.map(v => v.poll_id);
        appState.hasUnreadPoll = polls.some(p => !votedPollIds.includes(p.poll_id));
        
        const ratings = data.filter(d => d.type === 'rating');
        seriesDatabase.forEach(series => {
          const seriesRatings = ratings.filter(r => r.series_id === series.id);
          if (seriesRatings.length > 0) {
            const sum = seriesRatings.reduce((acc, r) => acc + r.rating, 0);
            series.rating = sum / seriesRatings.length;
            series.ratingCount = seriesRatings.length;
          }
        });
        
        if (['series', 'polls', 'home', 'profile'].includes(appState.currentScreen)) {
          render();
        }
      }
    };
    
    function getUserProfile(userId) {
      return appState.userData.find(d => d.type === 'user_profile' && d.user_id === userId);
    }
    
    function renderSplashScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const appName = window.elementSdk?.config?.app_name || defaultConfig.app_name;
      const tagline = window.elementSdk?.config?.tagline || defaultConfig.tagline;
      
      return `
        <div class="h-full w-full flex flex-col items-center justify-center fade-in" style="background-color: ${bgColor};">
          <div class="text-center">
            <h1 class="gradient-text mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 3}px; font-weight: 700;">${appName}</h1>
            <p class="mb-8" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.25}px; color: ${accentColor}; opacity: 0.9;">${tagline}</p>
            <div class="loader pulse-glow mx-auto" style="border-top-color: ${accentColor};"></div>
          </div>
        </div>
      `;
    }
    
    function renderLoginScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const secondaryAccent = window.elementSdk?.config?.secondary_accent || defaultConfig.secondary_accent;
      const appName = window.elementSdk?.config?.app_name || defaultConfig.app_name;
      const loginButton = window.elementSdk?.config?.login_button || defaultConfig.login_button;
      const signupButton = window.elementSdk?.config?.signup_button || defaultConfig.signup_button;
      const guestButton = window.elementSdk?.config?.guest_button || defaultConfig.guest_button;
      
      return `
        <div class="h-full w-full flex flex-col items-center justify-center px-6 fade-in" style="background-color: ${bgColor};">
          <div class="w-full max-w-md">
            <h1 class="gradient-text text-center mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 2.5}px; font-weight: 700;">${appName}</h1>
            <p class="text-center mb-8" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: ${accentColor}; opacity: 0.8;">Bienvenido a tu comunidad BL/GL</p>
            
            <form id="loginForm" class="space-y-4 mb-6">
              <div>
                <label for="email" class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Correo Electr√≥nico</label>
                <input 
                  type="email" 
                  id="email" 
                  required
                  class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                  style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  placeholder="tu@email.com"
                />
              </div>
              <div>
                <label for="password" class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Contrase√±a</label>
                <input 
                  type="password" 
                  id="password" 
                  required
                  class="w-full px-4 py-3 rounded-lg input-glow transition-all" 
                  style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
              <button 
                type="submit"
                id="loginSubmitBtn"
                class="w-full py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90"
                style="background: linear-gradient(135deg, ${accentColor}, ${secondaryAccent}); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px; color: white;"
              >
                ${loginButton}
              </button>
            </form>
            
            <button 
              id="signupBtn"
              class="w-full py-3 rounded-lg ripple font-semibold mb-4 transition-all hover:opacity-90"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px; color: ${accentColor};"
            >
              ${signupButton}
            </button>
            
            <button 
              id="guestBtn"
              class="w-full py-3 rounded-lg transition-all hover:opacity-70"
              style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: rgba(255, 255, 255, 0.6);"
            >
              ${guestButton}
            </button>
          </div>
        </div>
      `;
    }
    
    function renderHomeScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      const popularTitle = window.elementSdk?.config?.popular_title || defaultConfig.popular_title;
      const blTitle = window.elementSdk?.config?.bl_title || defaultConfig.bl_title;
      const glTitle = window.elementSdk?.config?.gl_title || defaultConfig.gl_title;
      const appName = window.elementSdk?.config?.app_name || defaultConfig.app_name;
      
      const popularSeries = seriesDatabase.filter(s => s.category === 'popular');
      const blSeries = seriesDatabase.filter(s => s.genre === 'BL');
      const glSeries = seriesDatabase.filter(s => s.genre === 'GL');
      const countries = ['Thailand', 'Korea', 'Japan', 'Taiwan', 'Philippines'];
      
      let userAvatar = 'üë§';
      if (appState.userProfile?.profile_picture) {
        if (appState.userProfile.profile_picture.startsWith('avatar-')) {
          const avatarId = appState.userProfile.profile_picture.replace('avatar-', '');
          const avatar = avatarLibrary.find(a => a.id === avatarId);
          if (avatar) userAvatar = `<img src="${avatar.url}" alt="${avatar.series}" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.parentElement.innerHTML='üë§';">`;
        }
      }
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <header class="sticky top-0 z-50 px-6 py-4 flex justify-between items-center" style="background: linear-gradient(180deg, ${bgColor} 0%, rgba(17, 24, 39, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <h1 class="gradient-text" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.75}px; font-weight: 700;">${appName}</h1>
            <div class="flex items-center gap-4">
              ${!appState.isGuest ? `
                <button id="pollsBtn" class="relative transition-all hover:opacity-80">
                  <svg class="w-8 h-8" fill="${accentColor}" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                  </svg>
                  ${appState.hasUnreadPoll ? '<div class="notification-dot"></div>' : ''}
                </button>
              ` : ''}
              <button id="profileBtn" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 1.5}px;">
                ${userAvatar}
              </button>
            </div>
          </header>
          
          <main class="desktop-container px-6 py-6">
            <section class="mb-8">
              <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: ${accentColor};">${popularTitle}</h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                ${popularSeries.map(series => `
                  <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                    <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center overflow-hidden">
                      <img src="${series.poster}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=&quot;font-family: ${customFont}, sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8; padding: 1rem; text-align: center;&quot;>${series.title}</span>';">
                    </div>
                    <div class="p-3">
                      <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                      <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.genre} ‚Ä¢ ${series.country}</p>
                      ${series.ratingCount > 0 ? `
                        <div class="flex items-center mt-2">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </section>
            
            <section class="mb-8">
              <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: #ec4899;">${blTitle}</h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                ${blSeries.slice(0, 5).map(series => `
                  <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                    <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center overflow-hidden">
                      <img src="${series.poster}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=&quot;font-family: ${customFont}, sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8; padding: 1rem; text-align: center;&quot;>${series.title}</span>';">
                    </div>
                    <div class="p-3">
                      <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                      <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.country}</p>
                      ${series.ratingCount > 0 ? `
                        <div class="flex items-center mt-2">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </section>
            
            <section class="mb-8">
              <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: #a855f7;">${glTitle}</h2>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                ${glSeries.map(series => `
                  <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                    <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center overflow-hidden">
                      <img src="${series.poster}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=&quot;font-family: ${customFont}, sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8; padding: 1rem; text-align: center;&quot;>${series.title}</span>';">
                    </div>
                    <div class="p-3">
                      <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                      <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.country}</p>
                      ${series.ratingCount > 0 ? `
                        <div class="flex items-center mt-2">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </section>
            
            ${countries.map(country => {
              const countrySeries = seriesDatabase.filter(s => s.country === country).slice(0, 5);
              if (countrySeries.length === 0) return '';
              
              return `
                <section class="mb-8">
                  <h2 class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: ${accentColor};">${country}</h2>
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    ${countrySeries.map(series => `
                      <div class="series-card rounded-lg overflow-hidden hover-zoom cursor-pointer" data-series-id="${series.id}">
                        <div class="aspect-[2/3] bg-gray-700 flex items-center justify-center overflow-hidden">
                          <img src="${series.poster}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=&quot;font-family: ${customFont}, sans-serif; font-size: ${baseFontSize * 0.875}px; color: white; opacity: 0.8; padding: 1rem; text-align: center;&quot;>${series.title}</span>';">
                        </div>
                        <div class="p-3">
                          <h3 class="font-semibold mb-1 truncate" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">${series.title}</h3>
                          <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${series.genre}</p>
                          ${series.ratingCount > 0 ? `
                            <div class="flex items-center mt-2">
                              <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)}</span>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </section>
              `;
            }).join('')}
          </main>
        </div>
      `;
    }
    
    function renderSeriesScreen() {
      if (!appState.selectedSeries) return;
      
      const series = appState.selectedSeries;
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const userEpisodes = appState.userData.filter(d => d.type === 'episode' && d.series_id === series.id && d.user_id === appState.currentUser?.id);
      const userRating = appState.userData.find(d => d.type === 'rating' && d.series_id === series.id && d.user_id === appState.currentUser?.id);
      const messages = appState.userData.filter(d => d.type === 'message' && d.series_id === series.id).sort((a, b) => a.timestamp - b.timestamp);
      
      const episodes = Array.from({ length: series.episodes }, (_, i) => i + 1);
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <div class="parallax-header relative" style="height: 40%; background: linear-gradient(180deg, rgba(17, 24, 39, 0.4), ${bgColor}), linear-gradient(135deg, ${series.genre === 'BL' ? '#ec4899' : '#a855f7'}, ${series.genre === 'BL' ? '#f472b6' : '#c084fc'});">
            <button id="backBtn" class="absolute top-4 left-4 w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);">
              <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            <div class="absolute bottom-4 left-6">
              <h1 class="font-bold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 2}px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">${series.title}</h1>
              <p style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; opacity: 0.9;">${series.genre} ‚Ä¢ ${series.country} ‚Ä¢ ${series.year}</p>
            </div>
          </div>
          
          <main class="desktop-container px-6 py-6">
            <div class="md:grid md:grid-cols-3 md:gap-8">
              <div class="md:col-span-2">
                <section class="mb-6">
                  <p class="mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; line-height: 1.6; opacity: 0.9;">${series.synopsis}</p>
                  <div class="grid grid-cols-2 gap-4 text-sm mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
                    <div>
                      <span class="opacity-70">Episodios:</span>
                      <span class="ml-2 font-semibold">${series.episodes}</span>
                    </div>
                    <div>
                      <span class="opacity-70">Duraci√≥n:</span>
                      <span class="ml-2 font-semibold">${series.duration}</span>
                    </div>
                  </div>
                  ${appState.currentUser && !appState.isGuest ? `
                    <button 
                      id="addToListBtn"
                      class="w-full py-3 rounded-lg font-semibold transition-all hover:opacity-90 ripple"
                      style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                    >
                      + Agregar a Mi Lista
                    </button>
                  ` : ''}
                </section>
                
                <section class="mb-6 p-4 rounded-lg" style="background-color: rgba(31, 41, 55, 0.6);">
                  <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Calificaci√≥n</h3>
                  ${series.ratingCount > 0 ? `
                    <p class="mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">‚òÖ ${series.rating.toFixed(1)} <span style="font-size: ${baseFontSize * 0.875}px; opacity: 0.7;">(${series.ratingCount} calificaciones)</span></p>
                  ` : `
                    <p class="mb-2 opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Sin calificaciones a√∫n</p>
                  `}
                  ${appState.currentUser && !appState.isGuest ? `
                    <div class="flex gap-2">
                      ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => `
                        <button class="star-rating ${userRating?.rating === rating ? 'opacity-100' : 'opacity-40'}" data-rating="${rating}" style="font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">‚òÖ</button>
                      `).join('')}
                    </div>
                    ${userRating ? `<p class="mt-2 text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Tu calificaci√≥n: ${userRating.rating}/10</p>` : ''}
                  ` : `
                    <p class="text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Inicia sesi√≥n para calificar</p>
                  `}
                </section>
                
                <section class="mb-6">
                  <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Comunidad</h3>
                  <div id="chatContainer" class="space-y-3 mb-4 max-h-80 overflow-y-auto p-4 rounded-lg" style="background-color: rgba(31, 41, 55, 0.4);">
                    ${messages.length > 0 ? messages.map(msg => {
                      const msgProfile = getUserProfile(msg.user_id);
                      let avatar = 'üë§';
                      if (msgProfile?.profile_picture) {
                        if (msgProfile.profile_picture.startsWith('avatar-')) {
                          const avatarId = msgProfile.profile_picture.replace('avatar-', '');
                          const avatarData = avatarLibrary.find(a => a.id === avatarId);
                          if (avatarData) avatar = `<img src="${avatarData.url}" alt="${avatarData.series}" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.parentElement.innerHTML='üë§';">`;
                        }
                      }
                      
                      return `
                        <div class="chat-bubble">
                          <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize}px;">
                              ${avatar}
                            </div>
                            <div class="flex-1">
                              <p class="font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">${msg.username}</p>
                              <p style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; opacity: 0.9;">${msg.message}</p>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('') : `
                      <p class="text-center opacity-50" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">No hay mensajes a√∫n. ¬°S√© el primero en comentar!</p>
                    `}
                  </div>
                  
                  ${appState.currentUser && !appState.isGuest ? `
                    <form id="chatForm" class="flex gap-2">
                      <input 
                        type="text" 
                        id="chatInput" 
                        required
                        placeholder="Escribe tu mensaje..."
                        class="flex-1 px-4 py-3 rounded-lg input-glow transition-all"
                        style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                      />
                      <button 
                        type="submit"
                        id="chatSubmitBtn"
                        class="px-6 py-3 rounded-lg ripple font-semibold transition-all hover:opacity-90"
                        style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
                      >
                        Enviar
                      </button>
                    </form>
                  ` : `
                    <p class="text-center text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Inicia sesi√≥n para participar en la comunidad</p>
                  `}
                </section>
              </div>
              
              <div class="md:col-span-1">
                <section class="mb-6">
                  <h3 class="mb-3 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">Episodios</h3>
                  <div class="space-y-2">
                    ${episodes.map(ep => {
                      const watched = userEpisodes.some(ue => ue.episode_number === ep && ue.watched);
                      return `
                        <div class="flex items-center justify-between p-3 rounded-lg transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.6);">
                          <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">Episodio ${ep}</span>
                          ${appState.currentUser && !appState.isGuest ? `
                            <button class="eye-toggle ${watched ? 'watched' : ''}" data-episode="${ep}">
                              <svg class="w-6 h-6 eye-icon ${watched ? 'watched' : ''}" fill="currentColor" viewBox="0 0 24 24">
                                ${watched ? 
                                  '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>' :
                                  '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>'
                                }
                              </svg>
                            </button>
                          ` : `
                            <svg class="w-6 h-6 opacity-30" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                            </svg>
                          `}
                        </div>
                      `;
                    }).join('')}
                  </div>
                  ${appState.isGuest ? `
                    <p class="mt-3 text-sm text-center opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Crea una cuenta para marcar episodios</p>
                  ` : ''}
                </section>
              </div>
            </div>
          </main>
        </div>
      `;
    }
    
    function renderPollsScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const polls = appState.userData.filter(d => d.type === 'poll');
      const seriesOfMonth = appState.userData.filter(d => d.type === 'series_of_month');
      const allVotes = appState.userData.filter(d => d.type === 'poll_vote');
      const userVotes = allVotes.filter(v => v.user_id === appState.currentUser?.id);
      
      const isAdmin = ADMIN_EMAILS.includes(appState.currentUser?.email);
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <header class="sticky top-0 z-50 px-6 py-4 flex justify-between items-center" style="background: linear-gradient(180deg, ${bgColor} 0%, rgba(17, 24, 39, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <button id="backToHome" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.8);">
              <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            <h1 class="gradient-text" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.75}px; font-weight: 700;">Comunidad</h1>
            <div class="w-10"></div>
          </header>
          
          <main class="desktop-container px-6 py-6">
            <section class="mb-8">
              <div class="flex justify-between items-center mb-4">
                <h2 style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: ${accentColor};">Serie del Mes</h2>
                ${isAdmin ? `
                  <button id="addSeriesBtn" class="px-4 py-2 rounded-lg transition-all hover:opacity-80" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
                    + A√±adir
                  </button>
                ` : ''}
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${seriesOfMonth.length > 0 ? seriesOfMonth.map(som => `
                  <div class="series-card rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                      <h3 class="font-bold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">${som.series_title}</h3>
                      ${isAdmin ? `
                        <button class="delete-series-btn text-red-500 hover:text-red-400 transition-all" data-backend-id="${som.__backendId}">
                          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                          </svg>
                        </button>
                      ` : ''}
                    </div>
                    <p class="opacity-70 mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${som.genre}</p>
                    <p class="opacity-90" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; line-height: 1.5;">${som.description}</p>
                  </div>
                `).join('') : `
                  <p class="opacity-50 col-span-2 text-center py-8" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">No hay series destacadas este mes</p>
                `}
              </div>
            </section>
            
            <section>
              <div class="flex justify-between items-center mb-4">
                <h2 style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; font-weight: 600; color: ${accentColor};">Encuestas</h2>
                ${isAdmin ? `
                  <button id="createPollBtn" class="px-4 py-2 rounded-lg transition-all hover:opacity-80" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">
                    + Nueva Encuesta
                  </button>
                ` : ''}
              </div>
              <div class="space-y-4">
                ${polls.length > 0 ? polls.map(poll => {
                  const options = [poll.option_1, poll.option_2, poll.option_3, poll.option_4].filter(o => o);
                  const pollVotes = allVotes.filter(v => v.poll_id === poll.poll_id);
                  const userVote = userVotes.find(v => v.poll_id === poll.poll_id);
                  const totalVotes = pollVotes.length;
                  
                  const voteCounts = {};
                  options.forEach(opt => voteCounts[opt] = 0);
                  pollVotes.forEach(v => {
                    if (voteCounts[v.option] !== undefined) voteCounts[v.option]++;
                  });
                  
                  return `
                    <div class="series-card rounded-lg p-4">
                      <div class="flex items-start justify-between mb-3">
                        <h3 class="font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.125}px;">${poll.question}</h3>
                        ${isAdmin ? `
                          <button class="delete-poll-btn text-red-500 hover:text-red-400 transition-all" data-backend-id="${poll.__backendId}">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                          </button>
                        ` : ''}
                      </div>
                      <div class="space-y-2">
                        ${options.map(option => {
                          const votes = voteCounts[option];
                          const percentage = totalVotes > 0 ? (votes / totalVotes * 100).toFixed(1) : 0;
                          const isUserVote = userVote?.option === option;
                          
                          return `
                            <button 
                              class="poll-option w-full text-left p-3 rounded-lg transition-all ${userVote ? 'cursor-default' : 'hover:opacity-80'}"
                              data-poll-id="${poll.poll_id}"
                              data-option="${option}"
                              ${userVote ? 'disabled' : ''}
                              style="background-color: rgba(31, 41, 55, ${isUserVote ? '0.8' : '0.4'}); border: 2px solid ${isUserVote ? accentColor : 'transparent'}; position: relative; overflow: hidden;"
                            >
                              <div class="absolute left-0 top-0 h-full transition-all" style="width: ${percentage}%; background: linear-gradient(90deg, ${accentColor}33, transparent);"></div>
                              <div class="relative flex justify-between items-center">
                                <span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${option}</span>
                                ${userVote ? `<span style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor}; font-weight: 600;">${percentage}% (${votes})</span>` : ''}
                              </div>
                            </button>
                          `;
                        }).join('')}
                      </div>
                      ${userVote ? `
                        <p class="mt-3 text-sm opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Total de votos: ${totalVotes}</p>
                      ` : ''}
                    </div>
                  `;
                }).join('') : `
                  <p class="opacity-50 text-center py-8" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px;">No hay encuestas activas</p>
                `}
              </div>
            </section>
          </main>
        </div>
      `;
    }
    
    function renderProfileScreen() {
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const bgColor = window.elementSdk?.config?.background_color || defaultConfig.background_color;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      let userAvatar = 'üë§';
      let userName = appState.isGuest ? 'Invitado' : (appState.userProfile?.display_name || appState.currentUser?.email?.split('@')[0] || 'Usuario');
      
      if (appState.userProfile?.profile_picture) {
        if (appState.userProfile.profile_picture.startsWith('avatar-')) {
          const avatarId = appState.userProfile.profile_picture.replace('avatar-', '');
          const avatar = avatarLibrary.find(a => a.id === avatarId);
          if (avatar) userAvatar = avatar.emoji;
        }
      }
      
      const userRatings = appState.userData.filter(d => d.type === 'rating' && d.user_id === appState.currentUser?.id);
      const watchedEpisodes = appState.userData.filter(d => d.type === 'episode' && d.user_id === appState.currentUser?.id && d.watched);
      
      return `
        <div class="h-full w-full overflow-auto smooth-scroll" style="background-color: ${bgColor};">
          <header class="sticky top-0 z-50 px-6 py-4 flex justify-between items-center" style="background: linear-gradient(180deg, ${bgColor} 0%, rgba(17, 24, 39, 0.95) 100%); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(16, 185, 129, 0.2);">
            <button id="backToHome" class="w-10 h-10 rounded-full flex items-center justify-center transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.8);">
              <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            <h1 class="gradient-text" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.75}px; font-weight: 700;">Perfil</h1>
            <div class="w-10"></div>
          </header>
          
          <main class="desktop-container px-6 py-6 max-w-2xl mx-auto">
            <section class="mb-8 text-center">
              <div class="w-24 h-24 mx-auto mb-4 rounded-full flex items-center justify-center overflow-hidden" style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 3}px;">
                ${userAvatar}
              </div>
              <h2 class="font-bold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px;">${userName}</h2>
              ${!appState.isGuest ? `
                <p class="opacity-70 mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">${appState.currentUser.email}</p>
                <button id="editProfileBtn" class="px-6 py-2 rounded-lg transition-all hover:opacity-80" style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px; color: ${accentColor};">
                  Editar Perfil
                </button>
              ` : `
                <p class="opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Modo Invitado</p>
              `}
            </section>
            
            ${!appState.isGuest ? `
              <section class="mb-6">
                <h3 class="mb-4 font-semibold" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.25}px; color: ${accentColor};">Estad√≠sticas</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div class="series-card rounded-lg p-4 text-center">
                    <p class="font-bold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 2}px; color: ${accentColor};">${userRatings.length}</p>
                    <p class="opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Series Calificadas</p>
                  </div>
                  <div class="series-card rounded-lg p-4 text-center">
                    <p class="font-bold mb-1" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 2}px; color: ${accentColor};">${watchedEpisodes.length}</p>
                    <p class="opacity-70" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Episodios Vistos</p>
                  </div>
                </div>
              </section>
            ` : ''}
            
            <section class="mb-6">
              <button id="logoutBtn" class="w-full py-3 rounded-lg transition-all hover:opacity-80" style="background-color: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: #ef4444;">
                ${appState.isGuest ? 'Volver al Login' : 'Cerrar Sesi√≥n'}
              </button>
            </section>
          </main>
        </div>
      `;
    }
    
    function render() {
      const app = document.getElementById('app');
      
      switch (appState.currentScreen) {
        case 'splash':
          app.innerHTML = renderSplashScreen();
          break;
        case 'login':
          app.innerHTML = renderLoginScreen();
          attachLoginHandlers();
          break;
        case 'home':
          app.innerHTML = renderHomeScreen();
          attachHomeHandlers();
          break;
        case 'series':
          app.innerHTML = renderSeriesScreen();
          attachSeriesHandlers();
          break;
        case 'polls':
          app.innerHTML = renderPollsScreen();
          attachPollsHandlers();
          break;
        case 'profile':
          app.innerHTML = renderProfileScreen();
          attachProfileHandlers();
          break;
      }
    }
    
    function attachLoginHandlers() {
      const loginForm = document.getElementById('loginForm');
      const signupBtn = document.getElementById('signupBtn');
      const guestBtn = document.getElementById('guestBtn');
      
      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const submitBtn = document.getElementById('loginSubmitBtn');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Cargando...';
          
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          
          try {
            const { signInWithEmailAndPassword } = window.firebaseAuthFunctions;
            const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
            appState.currentUser = { 
              id: userCredential.user.uid, 
              email: userCredential.user.email 
            };
            appState.isGuest = false;
            
            const profile = getUserProfile(appState.currentUser.id);
            if (profile) {
              appState.userProfile = profile;
            }
            
            appState.currentScreen = 'home';
            render();
          } catch (error) {
            showToast('Error al iniciar sesi√≥n. Verifica tus credenciales.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = window.elementSdk?.config?.login_button || defaultConfig.login_button;
          }
        });
      }
      
      if (signupBtn) {
        signupBtn.addEventListener('click', async () => {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          
          if (!email || !password) {
            showToast('Por favor completa los campos', 'error');
            return;
          }
          
          if (password.length < 6) {
            showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
            return;
          }
          
          if (appState.recordCount >= 999) {
            showToast('L√≠mite de registros alcanzado (999). Por favor contacta soporte.', 'error');
            return;
          }
          
          signupBtn.disabled = true;
          signupBtn.textContent = 'Creando...';
          
          try {
            const { createUserWithEmailAndPassword } = window.firebaseAuthFunctions;
            const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
            appState.currentUser = { 
              id: userCredential.user.uid, 
              email: userCredential.user.email 
            };
            appState.isGuest = false;
            
            const result = await window.dataSdk.create({
              type: 'user_profile',
              user_id: appState.currentUser.id,
              display_name: email.split('@')[0],
              profile_picture: 'avatar-bad-buddy'
            });
            
            if (result.isError) {
              showToast('Error al crear perfil', 'error');
            } else {
              showToast('¬°Cuenta creada con √©xito!', 'success');
            }
            
            appState.currentScreen = 'home';
            render();
          } catch (error) {
            showToast('Error al crear cuenta. El email puede estar en uso.', 'error');
            signupBtn.disabled = false;
            signupBtn.textContent = window.elementSdk?.config?.signup_button || defaultConfig.signup_button;
          }
        });
      }
      
      if (guestBtn) {
        guestBtn.addEventListener('click', () => {
          appState.currentUser = { id: 'guest-' + Date.now(), email: 'guest@kyb.com' };
          appState.isGuest = true;
          appState.currentScreen = 'home';
          render();
        });
      }
    }
    
    function attachHomeHandlers() {
      const seriesCards = document.querySelectorAll('[data-series-id]');
      const pollsBtn = document.getElementById('pollsBtn');
      const profileBtn = document.getElementById('profileBtn');
      
      seriesCards.forEach(card => {
        card.addEventListener('click', () => {
          const seriesId = card.getAttribute('data-series-id');
          appState.selectedSeries = seriesDatabase.find(s => s.id === seriesId);
          appState.currentScreen = 'series';
          render();
        });
      });
      
      if (pollsBtn) {
        pollsBtn.addEventListener('click', () => {
          appState.hasUnreadPoll = false;
          appState.currentScreen = 'polls';
          render();
        });
      }
      
      if (profileBtn) {
        profileBtn.addEventListener('click', () => {
          appState.currentScreen = 'profile';
          render();
        });
      }
    }
    
    async function attachSeriesHandlers() {
      const backBtn = document.getElementById('backBtn');
      const chatForm = document.getElementById('chatForm');
      const eyeToggles = document.querySelectorAll('.eye-toggle');
      const starRatings = document.querySelectorAll('.star-rating');
      const addToListBtn = document.getElementById('addToListBtn');
      
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          appState.currentScreen = 'home';
          render();
        });
      }
      
      if (addToListBtn) {
        addToListBtn.addEventListener('click', async () => {
          if (appState.recordCount >= 999) {
            showToast('L√≠mite de registros alcanzado (999)', 'error');
            return;
          }
          
          addToListBtn.disabled = true;
          addToListBtn.textContent = 'Agregando...';
          
          const existingInList = appState.userData.find(
            d => d.type === 'my_list' && 
            d.series_id === appState.selectedSeries.id && 
            d.user_id === appState.currentUser.id
          );
          
          if (existingInList) {
            showToast('Ya est√° en tu lista', 'info');
            addToListBtn.disabled = false;
            addToListBtn.textContent = '‚úì En Mi Lista';
            return;
          }
          
          const result = await window.dataSdk.create({
            type: 'my_list',
            series_id: appState.selectedSeries.id,
            user_id: appState.currentUser.id,
            added_at: Date.now()
          });
          
          if (result.isOk) {
            showToast('¬°Agregado a tu lista!', 'success');
            addToListBtn.textContent = '‚úì En Mi Lista';
          } else {
            showToast('Error al agregar', 'error');
            addToListBtn.disabled = false;
            addToListBtn.textContent = '+ Agregar a Mi Lista';
          }
        });
      }
      
      if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (appState.recordCount >= 999) {
            showToast('L√≠mite de registros alcanzado (999)', 'error');
            return;
          }
          
          const chatInput = document.getElementById('chatInput');
          const submitBtn = document.getElementById('chatSubmitBtn');
          const message = chatInput.value.trim();
          
          if (!message) return;
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Enviando...';
          
          const profile = getUserProfile(appState.currentUser.id);
          const username = profile?.display_name || appState.currentUser.email.split('@')[0];
          
          const result = await window.dataSdk.create({
            type: 'message',
            series_id: appState.selectedSeries.id,
            user_id: appState.currentUser.id,
            username: username,
            message: message,
            timestamp: Date.now()
          });
          
          if (result.isOk) {
            chatInput.value = '';
            showToast('Mensaje enviado', 'success');
          } else {
            showToast('Error al enviar mensaje', 'error');
          }
          
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar';
        });
      }
      
      eyeToggles.forEach(toggle => {
        toggle.addEventListener('click', async () => {
          if (appState.recordCount >= 999) {
            showToast('L√≠mite de registros alcanzado (999)', 'error');
            return;
          }
          
          toggle.disabled = true;
          
          const episode = parseInt(toggle.getAttribute('data-episode'));
          const existingEpisode = appState.userData.find(
            d => d.type === 'episode' && 
            d.series_id === appState.selectedSeries.id && 
            d.user_id === appState.currentUser.id && 
            d.episode_number === episode
          );
          
          if (existingEpisode) {
            const updated = { ...existingEpisode, watched: !existingEpisode.watched };
            const result = await window.dataSdk.update(updated);
            if (result.isError) {
              showToast('Error al actualizar', 'error');
            }
          } else {
            const result = await window.dataSdk.create({
              type: 'episode',
              series_id: appState.selectedSeries.id,
              user_id: appState.currentUser.id,
              episode_number: episode,
              watched: true
            });
            if (result.isError) {
              showToast('Error al marcar episodio', 'error');
            }
          }
          
          toggle.disabled = false;
        });
      });
      
      starRatings.forEach(star => {
        star.addEventListener('click', async () => {
          if (appState.recordCount >= 999) {
            showToast('L√≠mite de registros alcanzado (999)', 'error');
            return;
          }
          
          const rating = parseInt(star.getAttribute('data-rating'));
          const existingRating = appState.userData.find(
            d => d.type === 'rating' && 
            d.series_id === appState.selectedSeries.id && 
            d.user_id === appState.currentUser.id
          );
          
          if (existingRating) {
            const updated = { ...existingRating, rating: rating };
            const result = await window.dataSdk.update(updated);
            if (result.isOk) {
              showToast('Calificaci√≥n actualizada', 'success');
            } else {
              showToast('Error al actualizar', 'error');
            }
          } else {
            const result = await window.dataSdk.create({
              type: 'rating',
              series_id: appState.selectedSeries.id,
              user_id: appState.currentUser.id,
              rating: rating
            });
            if (result.isOk) {
              showToast('¬°Calificaci√≥n guardada!', 'success');
            } else {
              showToast('Error al guardar', 'error');
            }
          }
        });
      });
    }
    
    function attachPollsHandlers() {
      const backToHome = document.getElementById('backToHome');
      const createPollBtn = document.getElementById('createPollBtn');
      const addSeriesBtn = document.getElementById('addSeriesBtn');
      const pollOptions = document.querySelectorAll('.poll-option');
      const deletePollBtns = document.querySelectorAll('.delete-poll-btn');
      const deleteSeriesBtns = document.querySelectorAll('.delete-series-btn');
      
      if (backToHome) {
        backToHome.addEventListener('click', () => {
          appState.currentScreen = 'home';
          render();
        });
      }
      
      if (createPollBtn) {
        createPollBtn.addEventListener('click', () => {
          showCreatePollModal();
        });
      }
      
      if (addSeriesBtn) {
        addSeriesBtn.addEventListener('click', () => {
          showAddSeriesModal();
        });
      }
      
      pollOptions.forEach(option => {
        option.addEventListener('click', async (e) => {
          if (e.target.disabled) return;
          
          if (appState.recordCount >= 999) {
            showToast('L√≠mite de registros alcanzado (999)', 'error');
            return;
          }
          
          option.disabled = true;
          
          const pollId = option.getAttribute('data-poll-id');
          const selectedOption = option.getAttribute('data-option');
          
          const result = await window.dataSdk.create({
            type: 'poll_vote',
            poll_id: pollId,
            user_id: appState.currentUser.id,
            option: selectedOption,
            voted_at: Date.now()
          });
          
          if (result.isOk) {
            showToast('¬°Voto registrado!', 'success');
          } else {
            showToast('Error al votar', 'error');
            option.disabled = false;
          }
        });
      });
      
      deletePollBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          
          btn.disabled = true;
          btn.style.opacity = '0.5';
          
          const backendId = btn.getAttribute('data-backend-id');
          const poll = appState.userData.find(d => d.__backendId === backendId);
          if (poll) {
            const result = await window.dataSdk.delete(poll);
            if (result.isOk) {
              showToast('Encuesta eliminada', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
              btn.style.opacity = '1';
            }
          }
        });
      });
      
      deleteSeriesBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          
          btn.disabled = true;
          btn.style.opacity = '0.5';
          
          const backendId = btn.getAttribute('data-backend-id');
          const series = appState.userData.find(d => d.__backendId === backendId);
          if (series) {
            const result = await window.dataSdk.delete(series);
            if (result.isOk) {
              showToast('Serie eliminada', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
              btn.style.opacity = '1';
            }
          }
        });
      });
    }
    
    function attachProfileHandlers() {
      const backToHome = document.getElementById('backToHome');
      const logoutBtn = document.getElementById('logoutBtn');
      const editProfileBtn = document.getElementById('editProfileBtn');
      
      if (backToHome) {
        backToHome.addEventListener('click', () => {
          appState.currentScreen = 'home';
          render();
        });
      }
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          if (!appState.isGuest) {
            const { signOut } = window.firebaseAuthFunctions;
            await signOut(window.firebaseAuth);
          }
          appState.currentUser = null;
          appState.userProfile = null;
          appState.isGuest = false;
          appState.currentScreen = 'login';
          render();
        });
      }
      
      if (editProfileBtn) {
        editProfileBtn.addEventListener('click', () => {
          showEditProfileModal();
        });
      }
    }
    
    function showCreatePollModal() {
      if (appState.recordCount >= 999) {
        showToast('L√≠mite de registros alcanzado (999)', 'error');
        return;
      }
      
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const modal = document.createElement('div');
      modal.id = 'pollModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center px-6 modal-overlay';
      
      modal.innerHTML = `
        <div class="w-full max-w-md rounded-lg p-6" style="background-color: #1f2937;">
          <h2 class="font-bold mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">Nueva Encuesta</h2>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Pregunta</label>
            <input 
              type="text" 
              id="pollQuestion" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
              placeholder="¬øTu serie BL favorita?"
            />
          </div>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Opci√≥n 1</label>
            <input 
              type="text" 
              id="pollOption1" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            />
          </div>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Opci√≥n 2</label>
            <input 
              type="text" 
              id="pollOption2" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            />
          </div>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Opci√≥n 3 (opcional)</label>
            <input 
              type="text" 
              id="pollOption3" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            />
          </div>
          
          <div class="mb-6">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Opci√≥n 4 (opcional)</label>
            <input 
              type="text" 
              id="pollOption4" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            />
          </div>
          
          <div class="flex gap-3">
            <button 
              id="savePollBtn"
              class="flex-1 py-3 rounded-lg font-semibold transition-all hover:opacity-90"
              style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            >
              Crear
            </button>
            <button 
              id="cancelPollBtn"
              class="flex-1 py-3 rounded-lg transition-all hover:opacity-80"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: ${accentColor};"
            >
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const saveBtn = modal.querySelector('#savePollBtn');
      const cancelBtn = modal.querySelector('#cancelPollBtn');
      
      saveBtn.addEventListener('click', async () => {
        const question = modal.querySelector('#pollQuestion').value.trim();
        const option1 = modal.querySelector('#pollOption1').value.trim();
        const option2 = modal.querySelector('#pollOption2').value.trim();
        const option3 = modal.querySelector('#pollOption3').value.trim();
        const option4 = modal.querySelector('#pollOption4').value.trim();
        
        if (!question || !option1 || !option2) {
          showToast('Completa al menos la pregunta y 2 opciones', 'error');
          return;
        }
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'Creando...';
        
        const result = await window.dataSdk.create({
          type: 'poll',
          poll_id: 'poll-' + Date.now(),
          question: question,
          option_1: option1,
          option_2: option2,
          option_3: option3 || null,
          option_4: option4 || null,
          created_at: Date.now()
        });
        
        if (result.isOk) {
          showToast('Encuesta creada', 'success');
          modal.remove();
        } else {
          showToast('Error al crear encuesta', 'error');
          saveBtn.disabled = false;
          saveBtn.textContent = 'Crear';
        }
      });
      
      cancelBtn.addEventListener('click', () => {
        modal.remove();
      });
    }
    
    function showAddSeriesModal() {
      if (appState.recordCount >= 999) {
        showToast('L√≠mite de registros alcanzado (999)', 'error');
        return;
      }
      
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const modal = document.createElement('div');
      modal.id = 'seriesModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center px-6 modal-overlay';
      
      modal.innerHTML = `
        <div class="w-full max-w-md rounded-lg p-6" style="background-color: #1f2937;">
          <h2 class="font-bold mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">Nueva Serie del Mes</h2>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">T√≠tulo</label>
            <input 
              type="text" 
              id="seriesTitle" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            />
          </div>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">G√©nero</label>
            <input 
              type="text" 
              id="seriesGenre" 
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
              placeholder="BL / GL"
            />
          </div>
          
          <div class="mb-6">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Descripci√≥n</label>
            <textarea 
              id="seriesDescription" 
              rows="3"
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white; resize: none;"
            ></textarea>
          </div>
          
          <div class="flex gap-3">
            <button 
              id="saveSeriesBtn"
              class="flex-1 py-3 rounded-lg font-semibold transition-all hover:opacity-90"
              style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            >
              Guardar
            </button>
            <button 
              id="cancelSeriesBtn"
              class="flex-1 py-3 rounded-lg transition-all hover:opacity-80"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: ${accentColor};"
            >
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const saveBtn = modal.querySelector('#saveSeriesBtn');
      const cancelBtn = modal.querySelector('#cancelSeriesBtn');
      
      saveBtn.addEventListener('click', async () => {
        const title = modal.querySelector('#seriesTitle').value.trim();
        const genre = modal.querySelector('#seriesGenre').value.trim();
        const description = modal.querySelector('#seriesDescription').value.trim();
        
        if (!title || !genre || !description) {
          showToast('Completa todos los campos', 'error');
          return;
        }
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';
        
        const result = await window.dataSdk.create({
          type: 'series_of_month',
          series_title: title,
          genre: genre,
          description: description,
          created_at: Date.now()
        });
        
        if (result.isOk) {
          showToast('Serie agregada', 'success');
          modal.remove();
        } else {
          showToast('Error al agregar serie', 'error');
          saveBtn.disabled = false;
          saveBtn.textContent = 'Guardar';
        }
      });
      
      cancelBtn.addEventListener('click', () => {
        modal.remove();
      });
    }
    
    function showEditProfileModal() {
      if (appState.recordCount >= 999) {
        showToast('L√≠mite de registros alcanzado (999)', 'error');
        return;
      }
      
      const customFont = window.elementSdk?.config?.font_family || defaultConfig.font_family;
      const baseFontSize = window.elementSdk?.config?.font_size || defaultConfig.font_size;
      const accentColor = window.elementSdk?.config?.accent_color || defaultConfig.accent_color;
      
      const currentName = appState.userProfile?.display_name || appState.currentUser.email.split('@')[0];
      const currentAvatar = appState.userProfile?.profile_picture?.replace('avatar-', '') || 'bad-buddy';
      
      const modal = document.createElement('div');
      modal.id = 'editModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center px-6 modal-overlay';
      
      modal.innerHTML = `
        <div class="w-full max-w-md rounded-lg p-6 max-h-[90%] overflow-y-auto" style="background-color: #1f2937;">
          <h2 class="font-bold mb-4" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 1.5}px; color: ${accentColor};">Editar Perfil</h2>
          
          <div class="mb-4">
            <label class="block mb-2" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Nombre</label>
            <input 
              type="text" 
              id="editName" 
              value="${currentName}"
              class="w-full px-4 py-3 rounded-lg"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid rgba(16, 185, 129, 0.3); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            />
          </div>
          
          <div class="mb-6">
            <label class="block mb-3" style="font-family: '${customFont}', sans-serif; font-size: ${baseFontSize * 0.875}px;">Avatar</label>
            <div class="grid grid-cols-4 gap-3">
              ${avatarLibrary.map(avatar => `
                <div 
                  class="avatar-option w-16 h-16 rounded-full flex items-center justify-center overflow-hidden ${currentAvatar === avatar.id ? 'selected' : ''}"
                  data-avatar-id="${avatar.id}"
                  style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-size: ${baseFontSize * 1.5}px;"
                >
                  <img src="${avatar.url}" alt="${avatar.series}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='üë§';">
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="flex gap-3">
            <button 
              id="saveProfileBtn"
              class="flex-1 py-3 rounded-lg font-semibold transition-all hover:opacity-90"
              style="background: linear-gradient(135deg, ${accentColor}, rgba(236, 72, 153, 0.8)); font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: white;"
            >
              Guardar
            </button>
            <button 
              id="cancelEditBtn"
              class="flex-1 py-3 rounded-lg transition-all hover:opacity-80"
              style="background-color: rgba(31, 41, 55, 0.8); border: 2px solid ${accentColor}; font-family: '${customFont}', sans-serif; font-size: ${baseFontSize}px; color: ${accentColor};"
            >
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      let selectedAvatar = currentAvatar;
      
      const avatarOptions = modal.querySelectorAll('.avatar-option');
      avatarOptions.forEach(option => {
        option.addEventListener('click', () => {
          avatarOptions.forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          selectedAvatar = option.getAttribute('data-avatar-id');
        });
      });
      
      const saveBtn = modal.querySelector('#saveProfileBtn');
      const cancelBtn = modal.querySelector('#cancelEditBtn');
      
      saveBtn.addEventListener('click', async () => {
        const newName = modal.querySelector('#editName').value.trim();
        if (!newName) {
          showToast('El nombre no puede estar vac√≠o', 'error');
          return;
        }
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'Guardando...';
        
        const existingProfile = getUserProfile(appState.currentUser.id);
        
        if (existingProfile) {
          const updated = {
            ...existingProfile,
            display_name: newName,
            profile_picture: 'avatar-' + selectedAvatar
          };
          const result = await window.dataSdk.update(updated);
          if (result.isOk) {
            showToast('Perfil actualizado', 'success');
            modal.remove();
            render();
          } else {
            showToast('Error al actualizar', 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Guardar';
          }
        } else {
          const result = await window.dataSdk.create({
            type: 'user_profile',
            user_id: appState.currentUser.id,
            display_name: newName,
            profile_picture: 'avatar-' + selectedAvatar
          });
          if (result.isOk) {
            showToast('Perfil creado', 'success');
            modal.remove();
            render();
          } else {
            showToast('Error al crear perfil', 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Guardar';
          }
        }
      });
      
      cancelBtn.addEventListener('click', () => {
        modal.remove();
      });
    }
    
    async function initialize() {
      const { onAuthStateChanged } = window.firebaseAuthFunctions;
      
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        showToast('Error al inicializar', 'error');
      }
      
      let authChecked = false;
      
      onAuthStateChanged(window.firebaseAuth, (user) => {
        if (authChecked) return;
        authChecked = true;
        
        if (user) {
          appState.currentUser = { id: user.uid, email: user.email };
          appState.isGuest = false;
          
          const profile = getUserProfile(appState.currentUser.id);
          if (profile) {
            appState.userProfile = profile;
          }
          
          appState.currentScreen = 'home';
          render();
        } else {
          setTimeout(() => {
            appState.currentScreen = 'login';
            render();
          }, 1500);
        }
      });
      
      render();
    }
    
    const elementApi = {
      defaultConfig,
      onConfigChange: async (config) => {
        render();
      },
      mapToCapabilities: (config) => ({
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (config) => new Map([
        ['app_name', config.app_name || defaultConfig.app_name],
        ['tagline', config.tagline || defaultConfig.tagline],
        ['popular_title', config.popular_title || defaultConfig.popular_title],
        ['bl_title', config.bl_title || defaultConfig.bl_title],
        ['gl_title', config.gl_title || defaultConfig.gl_title],
        ['login_button', config.login_button || defaultConfig.login_button],
        ['signup_button', config.signup_button || defaultConfig.signup_button],
        ['guest_button', config.guest_button || defaultConfig.guest_button]
      ])
    };
    
    if (window.elementSdk) {
      window.elementSdk.init(elementApi);
    }
    
    initialize();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b5e97f045ca1a50',t:'MTc2NzA2Njg0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
