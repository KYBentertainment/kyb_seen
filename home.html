<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KYB Seen - BL/GL Tracking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore-compat.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Space Grotesk', sans-serif;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1f2937;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #10b981;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #059669;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
      50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(4); opacity: 0; }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    .slide-up {
      animation: slideUp 0.3s ease;
    }
    
    .slide-down {
      animation: slideDown 0.3s ease;
    }
    
    .pulse-glow {
      animation: pulseGlow 2s infinite;
    }
    
    .glassmorphism {
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }
    
    .btn-gradient-bl-gl {
      background: linear-gradient(135deg, #10b981, #ec4899);
    }
    
    .btn-gradient-bl-gl:hover {
      opacity: 0.85;
    }
    
    .avatar-gradient {
      background: linear-gradient(135deg, #10b981, rgba(236, 72, 153, 0.8));
    }
    
    .genre-badge-bl {
      background: #ec4899;
      color: #ffffff;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .genre-badge-gl {
      background: #a855f7;
      color: #ffffff;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .ripple-effect {
      position: relative;
      overflow: hidden;
    }
    
    .ripple-effect::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 50%;
      left: 50%;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
    }
    
    .ripple-effect:active::after {
      animation: ripple 0.6s ease-out;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full w-full bg-gray-900 text-white overflow-x-hidden">
  <div id="app" class="h-full w-full"></div>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBcjjoLZ3XU3SD8xgT6XmvZEVrmoV34A4M",
      authDomain: "kyb-seen.firebaseapp.com",
      projectId: "kyb-seen",
      storageBucket: "kyb-seen.firebasestorage.app",
      messagingSenderId: "916013840344",
      appId: "1:916013840344:web:561274a6db9470a7ca64ad",
      measurementId: "G-1C8ZDYR1JS"
    };
    
    // Initialize Firebase
    let auth = null;
    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
    } catch (error) {
      console.log('Firebase initialization error:', error);
    }
    
    // Global state
    const state = {
      user: null,
      currentView: 'home',
      currentSeries: null,
      allRecords: [],
      isGuest: false
    };
    
    // Firestore Data SDK Wrapper
    const firestoreDataSdk = {
      async create(record) {
        try {
          if (!db || !state.user) return { isOk: false, isError: true, error: new Error('Database not available') };
          
          const docRef = await db.collection('kyb_data').add({
            ...record,
            user_profile: record.user_profile || state.user.uid,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          return { isOk: true, isError: false, data: docRef.id };
        } catch (error) {
          console.error('Firestore create error:', error);
          return { isOk: false, isError: true, error };
        }
      },
      
      async update(record) {
        try {
          if (!db || !record.__backendId) return { isOk: false, isError: true, error: new Error('Invalid record') };
          
          const { __backendId, ...updateData } = record;
          await db.collection('kyb_data').doc(__backendId).update({
            ...updateData,
            updated_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          return { isOk: true, isError: false, data: null };
        } catch (error) {
          console.error('Firestore update error:', error);
          return { isOk: false, isError: true, error };
        }
      },
      
      async delete(record) {
        try {
          if (!db || !record.__backendId) return { isOk: false, isError: true, error: new Error('Invalid record') };
          
          await db.collection('kyb_data').doc(record.__backendId).delete();
          
          return { isOk: true, isError: false, data: null };
        } catch (error) {
          console.error('Firestore delete error:', error);
          return { isOk: false, isError: true, error };
        }
      },
      
      async init(handler) {
        try {
          if (!db) return { isOk: false, isError: true, error: new Error('Database not available') };
          
          // Listen to real-time updates
          db.collection('kyb_data').onSnapshot((snapshot) => {
            const records = [];
            snapshot.forEach((doc) => {
              records.push({
                __backendId: doc.id,
                ...doc.data()
              });
            });
            
            state.allRecords = records;
            handler.onDataChanged(records);
          });
          
          return { isOk: true, isError: false, data: null };
        } catch (error) {
          console.error('Firestore init error:', error);
          return { isOk: false, isError: true, error };
        }
      }
    };
    
    // Use Firestore as the active SDK (fallback to Canva SDK if available)
    window.activeDataSdk = window.dataSdk || firestoreDataSdk;
    
    // Default config
    const defaultConfig = {
      app_title: "KYB Seen",
      welcome_message: "Descubre y rastrea tus series BL/GL favoritas",
      popular_title: "Popular",
      bl_section_title: "Series BL",
      gl_section_title: "Series GL",
      login_title: "Bienvenido",
      register_title: "Crear Cuenta",
      guest_button: "Continuar como Invitado",
      primary_color: "#10b981",
      secondary_color: "#ec4899",
      background_color: "#111827",
      text_color: "#ffffff",
      card_color: "#1f2937"
    };
    
    // Admin emails
    const ADMIN_EMAILS = ['soportedekyb@gmail.com', 'elihuf07@gmail.com'];
    
    // Series data
    const SERIES_DATA = [
      { id: 's1', title: 'Bad Buddy', genre: 'BL', country: 'Thailand', rating: 9.2, votes: 1547, year: 2021, episodes: 12, duration: '45min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Bad+Buddy', synopsis: 'Pat y Pran, hijos de familias rivales, desarrollan una amistad secreta que se convierte en amor mientras navegan las expectativas familiares.' },
      { id: 's2', title: 'Semantic Error', genre: 'BL', country: 'Korea', rating: 9.0, votes: 1823, year: 2022, episodes: 8, duration: '25min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Semantic+Error', synopsis: 'Un estudiante de inform√°tica obsesionado con la lÔøΩÔøΩÔøΩÔøΩgica conoce a un dise√±ador art√≠stico, desafiando su visi√≥n racional del mundo.' },
      { id: 's3', title: 'GAP The Series', genre: 'GL', country: 'Thailand', rating: 8.8, votes: 1234, year: 2022, episodes: 12, duration: '50min', image: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=GAP+Series', synopsis: 'Sam, CEO de una empresa, se enamora de Mon, su nueva asistente, desafiando las normas sociales y corporativas.' },
      { id: 's4', title: 'Cherry Magic', genre: 'BL', country: 'Japan', rating: 8.9, votes: 2156, year: 2020, episodes: 12, duration: '24min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Cherry+Magic', synopsis: 'Adachi, un oficinista virgen de 30 a√±os, descubre que puede leer mentes y se entera de que su compa√±ero popular est√° enamorado de √©l.' },
      { id: 's5', title: 'We Best Love', genre: 'BL', country: 'Taiwan', rating: 8.7, votes: 1678, year: 2021, episodes: 12, duration: '30min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=We+Best+Love', synopsis: 'Dos rivales de secundaria se reencuentran a√±os despu√©s, descubriendo que su competencia escond√≠a sentimientos m√°s profundos.' },
      { id: 's6', title: 'The Handmaiden', genre: 'GL', country: 'Korea', rating: 9.5, votes: 3421, year: 2016, episodes: 1, duration: '145min', image: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=The+Handmaiden', synopsis: 'Una ladrona es contratada como sirvienta de una heredera japonesa, pero un plan de estafa se convierte en romance inesperado.' },
      { id: 's7', title: 'Gameboys', genre: 'BL', country: 'Philippines', rating: 8.6, votes: 1543, year: 2020, episodes: 13, duration: '15min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Gameboys', synopsis: 'Durante la cuarentena, Cairo y Gavreel desarrollan una conexi√≥n virtual que se convierte en algo m√°s significativo.' },
      { id: 's8', title: 'Tsukutabe', genre: 'GL', country: 'Japan', rating: 8.4, votes: 876, year: 2020, episodes: 12, duration: '24min', image: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=Tsukutabe', synopsis: 'Nomoto disfruta cocinar para Kasuga, su vecina, y juntas descubren una conexi√≥n m√°s profunda a trav√©s de la comida.' },
      { id: 's9', title: 'KinnPorsche', genre: 'BL', country: 'Thailand', rating: 8.9, votes: 2987, year: 2022, episodes: 14, duration: '60min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=KinnPorsche', synopsis: 'Un estudiante se convierte en guardaespaldas de un heredero mafioso, desarrollando una relaci√≥n complicada en medio del peligro.' },
      { id: 's10', title: 'Love Class', genre: 'BL', country: 'Korea', rating: 7.8, votes: 1234, year: 2022, episodes: 6, duration: '25min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Love+Class', synopsis: 'Estudiantes universitarios exploran el amor y las relaciones en una clase sobre ese tema.' },
      { id: 's11', title: 'Old Fashion Cupcake', genre: 'BL', country: 'Japan', rating: 9.1, votes: 1876, year: 2022, episodes: 5, duration: '24min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=Old+Fashion', synopsis: 'Un jefe de mediana edad y su subordinado m√°s joven descubren nuevas perspectivas sobre la vida y el amor.' },
      { id: 's12', title: 'Show Me Love', genre: 'GL', country: 'Thailand', rating: 8.2, votes: 765, year: 2023, episodes: 9, duration: '45min', image: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=Show+Me+Love', synopsis: 'Dos mujeres de diferentes mundos se encuentran y desaf√≠an las expectativas sobre el amor y la identidad.' },
      { id: 's13', title: 'History 3 MODC', genre: 'BL', country: 'Taiwan', rating: 8.8, votes: 1432, year: 2019, episodes: 20, duration: '30min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=History+3', synopsis: 'Un polic√≠a encubierto se infiltra en una banda y desarrolla sentimientos complicados por el l√≠der.' },
      { id: 's14', title: 'Lily Fever', genre: 'GL', country: 'Korea', rating: 8.0, votes: 654, year: 2015, episodes: 9, duration: '12min', image: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=Lily+Fever', synopsis: 'Una relaci√≥n entre dos mujeres se desarrolla con humor y ternura en esta serie web coreana.' },
      { id: 's15', title: 'My School President', genre: 'BL', country: 'Thailand', rating: 9.3, votes: 2543, year: 2023, episodes: 12, duration: '45min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=My+School+President', synopsis: 'El l√≠der de una banda escolar se enamora del presidente estudiantil en esta dulce historia de primer amor.' },
      { id: 's16', title: 'My Beautiful Man', genre: 'BL', country: 'Japan', rating: 8.5, votes: 1765, year: 2021, episodes: 6, duration: '24min', image: 'https://via.placeholder.com/300x450/ec4899/ffffff?text=My+Beautiful+Man', synopsis: 'Un estudiante t√≠mido desarrolla una obsesi√≥n por el chico popular de su clase, llevando a una relaci√≥n √∫nica.' },
      { id: 's17', title: 'Whisper Me a Love Song', genre: 'GL', country: 'Japan', rating: 8.6, votes: 987, year: 2024, episodes: 12, duration: '24min', image: 'https://via.placeholder.com/300x450/a855f7/ffffff?text=Whisper+Love', synopsis: 'Una estudiante de primer a√±o se enamora de una guitarrista de √∫ltimo a√±o despu√©s de escuchar su m√∫sica.' }
    ];
    
    // Avatar library by series
    const AVATAR_LIBRARY = [
      {
        series: 'Bad Buddy',
        characters: [
          { id: 'bb1', name: 'Pat', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=P' },
          { id: 'bb2', name: 'Pran', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=PR' },
          { id: 'bb3', name: 'Ink', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=I' },
          { id: 'bb4', name: 'Pa', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=PA' }
        ]
      },
      {
        series: 'Semantic Error',
        characters: [
          { id: 'se1', name: 'Sangwoo', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=SW' },
          { id: 'se2', name: 'Jaeyoung', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=JY' },
          { id: 'se3', name: 'Jiyeon', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=J' }
        ]
      },
      {
        series: 'GAP The Series',
        characters: [
          { id: 'gap1', name: 'Sam', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=S' },
          { id: 'gap2', name: 'Mon', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=M' },
          { id: 'gap3', name: 'Tee', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=T' },
          { id: 'gap4', name: 'Jim', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=JM' }
        ]
      },
      {
        series: 'Cherry Magic',
        characters: [
          { id: 'cm1', name: 'Adachi', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=A' },
          { id: 'cm2', name: 'Kurosawa', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=K' },
          { id: 'cm3', name: 'Tsuge', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=TS' }
        ]
      }
    ];
    
    // Toast notifications
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = `slide-down px-6 py-4 rounded-lg shadow-lg text-white font-semibold mb-3 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
      }`;
      toast.textContent = message;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'fixed top-4 right-4 z-50 flex flex-col items-end';
      container.style.width = '320px';
      document.body.appendChild(container);
      return container;
    }
    
    // Data handler for Canva SDK
    const dataHandler = {
      onDataChanged(data) {
        state.allRecords = data;
        
        if (state.currentView === 'home') {
          renderHome();
        } else if (state.currentView === 'series' && state.currentSeries) {
          renderSeriesDetail(state.currentSeries);
        } else if (state.currentView === 'polls') {
          renderPolls();
        } else if (state.currentView === 'profile') {
          renderProfile();
        }
      }
    };
    
    // Initialize app
    async function initializeApp() {
      try {
        // Initialize Firestore SDK
        if (db) {
          await firestoreDataSdk.init(dataHandler);
        }
        
        // Initialize Canva SDK if available
        if (window.dataSdk) {
          await window.dataSdk.init(dataHandler);
        }
        
        if (window.elementSdk) {
          await window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              const titleEl = document.getElementById('app-title');
              if (titleEl) titleEl.textContent = config.app_title || defaultConfig.app_title;
              
              const welcomeEl = document.getElementById('welcome-message');
              if (welcomeEl) welcomeEl.textContent = config.welcome_message || defaultConfig.welcome_message;
              
              const popularEl = document.getElementById('popular-title');
              if (popularEl) popularEl.textContent = config.popular_title || defaultConfig.popular_title;
              
              const blEl = document.getElementById('bl-section-title');
              if (blEl) blEl.textContent = config.bl_section_title || defaultConfig.bl_section_title;
              
              const glEl = document.getElementById('gl-section-title');
              if (glEl) glEl.textContent = config.gl_section_title || defaultConfig.gl_section_title;
              
              const loginTitleEl = document.getElementById('login-title');
              if (loginTitleEl) loginTitleEl.textContent = config.login_title || defaultConfig.login_title;
              
              const registerTitleEl = document.getElementById('register-title');
              if (registerTitleEl) registerTitleEl.textContent = config.register_title || defaultConfig.register_title;
              
              const guestBtnEl = document.getElementById('guest-button');
              if (guestBtnEl) guestBtnEl.textContent = config.guest_button || defaultConfig.guest_button;
            },
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.primary_color || defaultConfig.primary_color,
                  set: (value) => {
                    config.primary_color = value;
                    window.elementSdk.setConfig({ primary_color: value });
                  }
                },
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    config.background_color = value;
                    window.elementSdk.setConfig({ background_color: value });
                  }
                },
                {
                  get: () => config.card_color || defaultConfig.card_color,
                  set: (value) => {
                    config.card_color = value;
                    window.elementSdk.setConfig({ card_color: value });
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                },
                {
                  get: () => config.secondary_color || defaultConfig.secondary_color,
                  set: (value) => {
                    config.secondary_color = value;
                    window.elementSdk.setConfig({ secondary_color: value });
                  }
                }
              ],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
              ['app_title', config.app_title || defaultConfig.app_title],
              ['welcome_message', config.welcome_message || defaultConfig.welcome_message],
              ['popular_title', config.popular_title || defaultConfig.popular_title],
              ['bl_section_title', config.bl_section_title || defaultConfig.bl_section_title],
              ['gl_section_title', config.gl_section_title || defaultConfig.gl_section_title],
              ['login_title', config.login_title || defaultConfig.login_title],
              ['register_title', config.register_title || defaultConfig.register_title],
              ['guest_button', config.guest_button || defaultConfig.guest_button]
            ])
          });
        }
      } catch (error) {
        console.error('SDK initialization error:', error);
      }
      
      if (auth) {
        auth.onAuthStateChanged((user) => {
          if (user) {
            state.user = user;
            state.isGuest = false;
            navigateTo('home');
          } else if (state.isGuest) {
            navigateTo('home');
          } else {
            navigateTo('login');
          }
        });
      } else {
        navigateTo('login');
      }
    }
    
    // Navigation
    function navigateTo(view, data = null) {
      state.currentView = view;
      state.currentSeries = data;
      
      switch(view) {
        case 'login':
          renderLogin();
          break;
        case 'register':
          renderRegister();
          break;
        case 'home':
          renderHome();
          break;
        case 'series':
          renderSeriesDetail(data);
          break;
        case 'polls':
          renderPolls();
          break;
        case 'profile':
          renderProfile();
          break;
      }
    }
    
    // Render login
    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-6 fade-in">
          <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 slide-up">
            <div class="text-center mb-8">
              <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-green-500 to-pink-500 bg-clip-text text-transparent">${config.app_title || defaultConfig.app_title}</h1>
              <p class="text-gray-400 text-base">${config.welcome_message || defaultConfig.welcome_message}</p>
            </div>
            
            <h2 id="login-title" class="text-2xl font-semibold mb-6">${config.login_title || defaultConfig.login_title}</h2>
            
            <form id="login-form" class="space-y-4">
              <div>
                <label for="email" class="block text-sm font-semibold mb-2">Email</label>
                <input type="email" id="email" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <div>
                <label for="password" class="block text-sm font-semibold mb-2">Contrase√±a</label>
                <input type="password" id="password" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <button type="submit" class="w-full btn-gradient-bl-gl text-white font-bold py-3 rounded-lg ripple-effect transition">
                Iniciar Sesi√≥n
              </button>
            </form>
            
            <div class="mt-6 space-y-3">
              <button id="register-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg ripple-effect transition">
                Crear Cuenta Nueva
              </button>
              
              <button id="guest-btn" class="w-full bg-transparent border-2 border-green-500 text-green-500 hover:bg-green-500 hover:text-white font-semibold py-3 rounded-lg ripple-effect transition">
                <span id="guest-button">${config.guest_button || defaultConfig.guest_button}</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!auth) {
          showToast('Firebase no disponible. Intenta en Canva.', 'error');
          return;
        }
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = e.target.querySelector('button[type="submit"]');
        
        btn.disabled = true;
        btn.textContent = 'Iniciando...';
        
        try {
          await auth.signInWithEmailAndPassword(email, password);
          showToast('¬°Bienvenido de vuelta!', 'success');
        } catch (error) {
          showToast(error.message, 'error');
          btn.disabled = false;
          btn.textContent = 'Iniciar Sesi√≥n';
        }
      });
      
      document.getElementById('register-btn').addEventListener('click', () => {
        navigateTo('register');
      });
      
      document.getElementById('guest-btn').addEventListener('click', () => {
        state.isGuest = true;
        state.user = { uid: 'guest', email: 'guest@kyb.seen', displayName: 'Invitado' };
        navigateTo('home');
        showToast('Modo invitado activado', 'info');
      });
    }
    
    // Render register
    function renderRegister() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-6 fade-in">
          <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 slide-up">
            <button id="back-btn" class="mb-4 text-green-500 hover:text-green-400 flex items-center transition">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Volver
            </button>
            
            <h2 id="register-title" class="text-2xl font-semibold mb-6">${config.register_title || defaultConfig.register_title}</h2>
            
            <form id="register-form" class="space-y-4">
              <div>
                <label for="reg-email" class="block text-sm font-semibold mb-2">Email</label>
                <input type="email" id="reg-email" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <div>
                <label for="reg-password" class="block text-sm font-semibold mb-2">Contrase√±a (m√≠nimo 6 caracteres)</label>
                <input type="password" id="reg-password" required minlength="6" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <div>
                <label for="reg-username" class="block text-sm font-semibold mb-2">Nombre de usuario</label>
                <input type="text" id="reg-username" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <button type="submit" class="w-full btn-gradient-bl-gl text-white font-bold py-3 rounded-lg ripple-effect transition">
                Registrarse
              </button>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => {
        navigateTo('login');
      });
      
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!auth) {
          showToast('Firebase no disponible. Intenta en Canva.', 'error');
          return;
        }
        
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const username = document.getElementById('reg-username').value;
        const btn = e.target.querySelector('button[type="submit"]');
        
        if (password.length < 6) {
          showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
          return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Registrando...';
        
        try {
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          await userCredential.user.updateProfile({ displayName: username });
          
          if (window.dataSdk && state.allRecords.length < 999) {
            const createResult = await window.dataSdk.create({
              user_profile: userCredential.user.uid,
              username: username,
              subname: '',
              avatar_series_id: '',
              avatar_character_id: '',
              avatar_url: '',
              email: email
            });
            
            if (createResult.isOk) {
              showToast('¬°Cuenta creada con √©xito!', 'success');
            } else {
              showToast('Cuenta creada, pero error al crear perfil', 'info');
            }
          } else {
            showToast('¬°Cuenta creada con √©xito!', 'success');
          }
        } catch (error) {
          showToast(error.message, 'error');
          btn.disabled = false;
          btn.textContent = 'Registrarse';
        }
      });
    }
    
    // Render home
    function renderHome() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      
      const blSeries = SERIES_DATA.filter(s => s.genre === 'BL');
      const glSeries = SERIES_DATA.filter(s => s.genre === 'GL');
      const popular = [...SERIES_DATA].sort((a, b) => b.rating - a.rating).slice(0, 6);
      
      const countrySections = {
        'Thailand': SERIES_DATA.filter(s => s.country === 'Thailand'),
        'Korea': SERIES_DATA.filter(s => s.country === 'Korea'),
        'Japan': SERIES_DATA.filter(s => s.country === 'Japan'),
        'Taiwan': SERIES_DATA.filter(s => s.country === 'Taiwan'),
        'Philippines': SERIES_DATA.filter(s => s.country === 'Philippines')
      };
      
      const userProfile = state.allRecords.find(r => r.user_profile === state.user?.uid);
      const avatarUrl = userProfile?.avatar_url || '';
      
      const pollsCount = state.allRecords.filter(r => r.poll_id).length;
      const seriesMonthCount = state.allRecords.filter(r => r.series_month_series_id).length;
      const hasPollsIndicator = pollsCount > 0 || seriesMonthCount > 0;
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <header class="sticky top-0 z-40 glassmorphism border-b border-gray-700">
            <div class="max-w-screen-xl mx-auto px-6 py-4 flex items-center justify-between">
              <h1 id="app-title" class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-green-500 to-pink-500 bg-clip-text text-transparent">${config.app_title || defaultConfig.app_title}</h1>
              
              <div class="flex items-center gap-4">
                <button id="polls-btn" class="relative bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold transition ripple-effect">
                  üìä Polls
                  ${hasPollsIndicator ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-pink-500 rounded-full pulse-glow"></span>' : ''}
                </button>
                
                <button id="profile-btn" class="w-10 h-10 rounded-full overflow-hidden border-2 border-green-500 hover:scale-110 transition ${avatarUrl ? '' : 'avatar-gradient'}">
                  ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-white font-bold">U</div>'}
                </button>
              </div>
            </div>
          </header>
          
          <!-- Main content -->
          <main class="max-w-screen-xl mx-auto px-6 py-8 pb-24 md:pb-8">
            <p id="welcome-message" class="text-lg text-gray-300 mb-8">${config.welcome_message || defaultConfig.welcome_message}</p>
            
            <!-- Popular -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 id="popular-title" class="text-2xl md:text-3xl font-bold">${config.popular_title || defaultConfig.popular_title}</h2>
                <button class="see-more-btn text-green-500 hover:text-green-400 font-semibold transition flex items-center gap-2" data-section="popular">
                  Ver m√°s
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                ${popular.map(series => createSeriesCard(series)).join('')}
              </div>
            </section>
            
            <!-- BL Series -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 id="bl-section-title" class="text-2xl md:text-3xl font-bold">${config.bl_section_title || defaultConfig.bl_section_title}</h2>
                <button class="see-more-btn text-green-500 hover:text-green-400 font-semibold transition flex items-center gap-2" data-section="bl">
                  Ver m√°s
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                ${blSeries.map(series => createSeriesCard(series)).join('')}
              </div>
            </section>
            
            <!-- GL Series -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 id="gl-section-title" class="text-2xl md:text-3xl font-bold">${config.gl_section_title || defaultConfig.gl_section_title}</h2>
                <button class="see-more-btn text-green-500 hover:text-green-400 font-semibold transition flex items-center gap-2" data-section="gl">
                  Ver m√°s
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                ${glSeries.map(series => createSeriesCard(series)).join('')}
              </div>
            </section>
            
            <!-- By country -->
            ${Object.entries(countrySections).map(([country, series]) => `
              <section class="mb-12">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-2xl md:text-3xl font-bold">${country}</h2>
                  <button class="see-more-btn text-green-500 hover:text-green-400 font-semibold transition flex items-center gap-2" data-section="${country.toLowerCase()}">
                    Ver m√°s
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                  ${series.map(s => createSeriesCard(s)).join('')}
                </div>
              </section>
            `).join('')}
          </main>
          
          <!-- Mobile nav -->
          <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 z-40">
            <div class="flex items-center justify-around py-3">
              <button class="nav-btn flex flex-col items-center text-green-500 font-semibold">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <span class="text-xs">Inicio</span>
              </button>
              
              <button id="mobile-polls-btn" class="nav-btn flex flex-col items-center text-gray-400 hover:text-green-500 font-semibold transition relative">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                </svg>
                <span class="text-xs">Polls</span>
                ${hasPollsIndicator ? '<span class="absolute top-0 right-2 w-2 h-2 bg-pink-500 rounded-full"></span>' : ''}
              </button>
              
              <button id="mobile-profile-btn" class="nav-btn flex flex-col items-center text-gray-400 hover:text-green-500 font-semibold transition">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-xs">Perfil</span>
              </button>
            </div>
          </nav>
        </div>
      `;
      
      document.getElementById('polls-btn').addEventListener('click', () => navigateTo('polls'));
      document.getElementById('mobile-polls-btn').addEventListener('click', () => navigateTo('polls'));
      document.getElementById('profile-btn').addEventListener('click', () => navigateTo('profile'));
      document.getElementById('mobile-profile-btn').addEventListener('click', () => navigateTo('profile'));
      
      // Ver m√°s buttons
      document.querySelectorAll('.see-more-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.dataset.section;
          showToast(`Pr√≥ximamente: Ver m√°s de ${section}`, 'info');
        });
      });
      
      document.querySelectorAll('.series-card').forEach(card => {
        card.addEventListener('click', () => {
          const seriesId = card.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
    }
    
    function createSeriesCard(series) {
      const userRating = state.allRecords.find(r => r.rating_series_id === series.id && r.user_profile === state.user?.uid);
      const userRatingValue = userRating ? userRating.rating_value : 0;
      
      return `
        <div class="series-card card-hover bg-gray-800 rounded-xl overflow-hidden cursor-pointer" data-series-id="${series.id}">
          <div class="aspect-[2/3] bg-gray-700">
            <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover">
          </div>
          <div class="p-4">
            <h3 class="font-bold text-base mb-2 line-clamp-2">${series.title}</h3>
            <div class="flex items-center justify-between mb-2">
              <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'}">${series.genre}</span>
              <span class="text-sm text-gray-400">${series.country}</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="flex items-center gap-1">
                ${renderStars(userRatingValue || series.rating)}
              </div>
              <span class="text-sm text-gray-400">${series.rating}</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderStars(rating, size = 'w-4 h-4') {
      const fullStars = Math.floor(rating / 2);
      const hasHalfStar = rating % 2 >= 1;
      let stars = '';
      
      for (let i = 0; i < fullStars; i++) {
        stars += `<svg class="${size} text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
      }
      
      if (hasHalfStar) {
        stars += `<svg class="${size} text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" opacity="0.5"></path></svg>`;
      }
      
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) {
        stars += `<svg class="${size} text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
      }
      
      return stars;
    }
    
    // Render series detail
    function renderSeriesDetail(series) {
      const app = document.getElementById('app');
      const gradient = series.genre === 'BL' ? 'from-pink-500/20' : 'from-purple-500/20';
      
      const userRating = state.allRecords.find(r => r.rating_series_id === series.id && r.user_profile === state.user?.uid);
      const allRatings = state.allRecords.filter(r => r.rating_series_id === series.id && r.rating_value);
      const avgRating = allRatings.length > 0 ? (allRatings.reduce((sum, r) => sum + r.rating_value, 0) / allRatings.length).toFixed(1) : series.rating;
      const totalVotes = allRatings.length || series.votes;
      
      const inMyList = state.allRecords.some(r => r.my_list_series_id === series.id && r.user_profile === state.user?.uid);
      
      const messages = state.allRecords
        .filter(r => r.message_series_id === series.id)
        .sort((a, b) => a.message_timestamp - b.message_timestamp)
        .map(msg => {
          const profile = state.allRecords.find(p => p.user_profile === msg.user_profile);
          return {
            ...msg,
            username: profile?.username || 'Usuario',
            subname: profile?.subname || '',
            avatar: profile?.avatar_url || ''
          };
        });
      
      const episodeRecords = state.allRecords.filter(r => r.episode_series_id === series.id && r.user_profile === state.user?.uid);
      const watchedCount = episodeRecords.filter(r => r.watched).length;
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <div class="relative h-64 md:h-80 bg-gradient-to-b ${gradient} to-gray-900">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
            <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover opacity-40">
            
            <button id="back-btn" class="absolute top-4 left-4 bg-gray-900/80 backdrop-blur-sm p-3 rounded-full hover:bg-gray-800 transition">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            
            <div class="absolute bottom-0 left-0 right-0 p-6">
              <h1 class="text-4xl md:text-5xl font-bold mb-2">${series.title}</h1>
              <div class="flex items-center gap-3 flex-wrap">
                <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'}">${series.genre}</span>
                <span class="text-sm text-gray-300">${series.country} ÔøΩÔøΩ ${series.year}</span>
                <span class="text-sm text-gray-300">${series.episodes} eps ‚Ä¢ ${series.duration}</span>
              </div>
            </div>
          </div>
          
          <!-- Content -->
          <div class="max-w-screen-xl mx-auto px-6 py-8 grid md:grid-cols-[1fr_300px] gap-8">
            <!-- Main content -->
            <div>
              <!-- Synopsis -->
              <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Sinopsis</h2>
                <p class="text-gray-300 text-base leading-relaxed">${series.synopsis}</p>
              </section>
              
              <!-- My List button -->
              <button id="my-list-btn" class="mb-8 ${inMyList ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} text-white font-bold px-6 py-3 rounded-lg ripple-effect transition ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}">
                ${inMyList ? '‚úì En Mi Lista' : '+ Agregar a Mi Lista'}
              </button>
              
              <!-- Rating -->
              <section class="mb-8 bg-gray-800 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Calificaci√≥n</h2>
                <div class="flex items-center gap-6 mb-4">
                  <div class="text-center">
                    <div class="text-4xl font-bold text-green-500">${avgRating}</div>
                    <div class="text-sm text-gray-400">${totalVotes} votos</div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-1 mb-2">
                      ${renderStars(avgRating * 2, 'w-6 h-6')}
                    </div>
                    <div class="text-sm text-gray-400">Promedio: ${avgRating}/10</div>
                  </div>
                </div>
                
                ${state.isGuest ? '<p class="text-gray-400 text-sm">Inicia sesi√≥n para calificar</p>' : `
                  <div>
                    <p class="text-sm font-semibold mb-3">Tu calificaci√≥n: ${userRating ? userRating.rating_value + '/10' : 'Sin calificar'}</p>
                    <div class="flex gap-2" id="rating-buttons">
                      ${[1,2,3,4,5,6,7,8,9,10].map(num => `
                        <button class="rating-btn ${userRating?.rating_value === num ? 'bg-green-500' : 'bg-gray-700 hover:bg-gray-600'} text-white font-bold w-10 h-10 rounded-lg ripple-effect transition" data-rating="${num}">
                          ${num}
                        </button>
                      `).join('')}
                    </div>
                  </div>
                `}
              </section>
              
              <!-- Chat -->
              <section class="bg-gray-800 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Chat Comunitario</h2>
                
                ${state.isGuest ? '<p class="text-gray-400 text-sm mb-4">Inicia sesi√≥n para participar en el chat</p>' : ''}
                
                <div id="chat-messages" class="space-y-4 mb-4 max-h-96 overflow-y-auto">
                  ${messages.length === 0 ? '<p class="text-gray-400 text-sm text-center py-8">No hay mensajes a√∫n. ¬°S√© el primero en comentar!</p>' : messages.map(msg => `
                    <div class="flex gap-3 slide-up">
                      <div class="w-10 h-10 rounded-full flex-shrink-0 overflow-hidden ${msg.avatar ? '' : 'avatar-gradient'}">
                        ${msg.avatar ? `<img src="${msg.avatar}" alt="${msg.username}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-white font-bold">${msg.username[0].toUpperCase()}</div>`}
                      </div>
                      <div class="flex-1">
                        <div class="mb-1">
                          <div class="font-bold text-sm">${msg.username}</div>
                          ${msg.subname ? `<div class="text-xs text-gray-400">@${msg.subname}</div>` : ''}
                        </div>
                        <p class="text-gray-300 text-sm">${msg.message_text}</p>
                      </div>
                    </div>
                  `).join('')}
                </div>
                
                ${!state.isGuest ? `
                  <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-2 rounded-lg ripple-effect transition">
                      Enviar
                    </button>
                  </form>
                ` : ''}
              </section>
            </div>
            
            <!-- Sidebar -->
            <div>
              <div class="bg-gray-800 rounded-xl p-6 sticky top-4">
                <h3 class="text-xl font-bold mb-4">Episodios (${watchedCount}/${series.episodes})</h3>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                  ${Array.from({length: series.episodes}, (_, i) => {
                    const epNum = i + 1;
                    const watched = episodeRecords.some(r => r.episode_number === epNum && r.watched);
                    return `
                      <button class="episode-btn w-full flex items-center justify-between bg-gray-700 hover:bg-gray-600 p-3 rounded-lg transition ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}" data-episode="${epNum}">
                        <span class="font-semibold">Episodio ${epNum}</span>
                        <svg class="w-5 h-5 ${watched ? 'text-green-500' : 'text-gray-500'}" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                        </svg>
                      </button>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => navigateTo('home'));
      
      document.getElementById('my-list-btn')?.addEventListener('click', async () => {
        if (state.isGuest) {
          showToast('Inicia sesi√≥n para usar Mi Lista', 'info');
          return;
        }
        
        if (!window.activeDataSdk) {
          showToast('Base de datos no disponible', 'error');
          return;
        }
        
        const btn = document.getElementById('my-list-btn');
        btn.disabled = true;
        
        if (inMyList) {
          const record = state.allRecords.find(r => r.my_list_series_id === series.id && r.user_profile === state.user.uid);
          if (record) {
            const result = await window.activeDataSdk.delete(record);
            if (result.isOk) {
              showToast('Eliminado de Mi Lista', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
            }
          }
        } else {
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            btn.disabled = false;
            return;
          }
          
          const result = await window.activeDataSdk.create({
            my_list_series_id: series.id,
            user_profile: state.user.uid
          });
          
          if (result.isOk) {
            showToast('Agregado a Mi Lista', 'success');
          } else {
            showToast('Error al agregar', 'error');
            btn.disabled = false;
          }
        }
      });
      
      document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (state.isGuest) return;
          
          if (!window.activeDataSdk) {
            showToast('Base de datos no disponible', 'error');
            return;
          }
          
          const rating = parseInt(btn.dataset.rating);
          btn.disabled = true;
          
          const existingRating = state.allRecords.find(r => r.rating_series_id === series.id && r.user_profile === state.user.uid);
          
          if (existingRating) {
            existingRating.rating_value = rating;
            const result = await window.activeDataSdk.update(existingRating);
            if (result.isOk) {
              showToast(`Calificaci√≥n actualizada: ${rating}/10`, 'success');
            } else {
              showToast('Error al actualizar', 'error');
              btn.disabled = false;
            }
          } else {
            if (state.allRecords.length >= 999) {
              showToast('L√≠mite de 999 registros alcanzado', 'error');
              btn.disabled = false;
              return;
            }
            
            const result = await window.activeDataSdk.create({
              rating_series_id: series.id,
              rating_value: rating,
              user_profile: state.user.uid
            });
            
            if (result.isOk) {
              showToast(`Calificado: ${rating}/10`, 'success');
            } else {
              showToast('Error al calificar', 'error');
              btn.disabled = false;
            }
          }
        });
      });
      
      document.getElementById('chat-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!window.activeDataSdk) {
          showToast('Base de datos no disponible', 'error');
          return;
        }
        
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || state.isGuest) return;
        
        if (state.allRecords.length >= 999) {
          showToast('L√≠mite de 999 registros alcanzado', 'error');
          return;
        }
        
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'Enviando...';
        
        const result = await window.activeDataSdk.create({
          message_series_id: series.id,
          message_text: message,
          message_timestamp: Date.now(),
          user_profile: state.user.uid
        });
        
        if (result.isOk) {
          input.value = '';
          showToast('Mensaje enviado', 'success');
        } else {
          showToast('Error al enviar mensaje', 'error');
        }
        
        btn.disabled = false;
        btn.textContent = 'Enviar';
      });
      
      document.querySelectorAll('.episode-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (state.isGuest) {
            showToast('Inicia sesi√≥n para marcar episodios', 'info');
            return;
          }
          
          if (!window.activeDataSdk) {
            showToast('Base de datos no disponible', 'error');
            return;
          }
          
          const epNum = parseInt(btn.dataset.episode);
          btn.disabled = true;
          
          const existingEpisode = state.allRecords.find(r => 
            r.episode_series_id === series.id && 
            r.episode_number === epNum && 
            r.user_profile === state.user.uid
          );
          
          if (existingEpisode) {
            existingEpisode.watched = !existingEpisode.watched;
            const result = await window.activeDataSdk.update(existingEpisode);
            if (!result.isOk) {
              showToast('Error al actualizar', 'error');
              btn.disabled = false;
            }
          } else {
            if (state.allRecords.length >= 999) {
              showToast('L√≠mite de 999 registros alcanzado', 'error');
              btn.disabled = false;
              return;
            }
            
            const result = await window.activeDataSdk.create({
              episode_series_id: series.id,
              episode_number: epNum,
              watched: true,
              user_profile: state.user.uid
            });
            
            if (!result.isOk) {
              showToast('Error al marcar episodio', 'error');
              btn.disabled = false;
            }
          }
        });
      });
      
      setTimeout(() => {
        const chatDiv = document.getElementById('chat-messages');
        if (chatDiv) chatDiv.scrollTop = chatDiv.scrollHeight;
      }, 100);
    }
    
    // Render polls
    function renderPolls() {
      const app = document.getElementById('app');
      const isAdmin = ADMIN_EMAILS.includes(state.user?.email || '');
      
      const seriesOfMonth = state.allRecords.filter(r => r.series_month_series_id);
      const polls = state.allRecords.filter(r => r.poll_id);
      const userVotes = state.allRecords.filter(r => r.poll_vote_poll_id && r.user_profile === state.user?.uid);
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <header class="sticky top-0 z-40 glassmorphism border-b border-gray-700">
            <div class="max-w-screen-xl mx-auto px-6 py-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <button id="back-btn" class="text-green-500 hover:text-green-400 transition">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h1 class="text-2xl md:text-3xl font-bold">Polls & Votaciones</h1>
              </div>
            </div>
          </header>
          
          <main class="max-w-screen-xl mx-auto px-6 py-8">
            <!-- Series del Mes -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Serie del Mes</h2>
                ${isAdmin && seriesOfMonth.length < 2 ? `
                  <button id="add-series-month-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                    + Agregar Serie
                  </button>
                ` : ''}
              </div>
              
              ${seriesOfMonth.length === 0 ? '<p class="text-gray-400">No hay series del mes seleccionadas</p>' : ''}
              
              <div class="grid md:grid-cols-2 gap-6">
                ${seriesOfMonth.map(sm => {
                  const series = SERIES_DATA.find(s => s.id === sm.series_month_series_id);
                  if (!series) return '';
                  return `
                    <div class="bg-gray-800 rounded-xl overflow-hidden card-hover">
                      <div class="aspect-video bg-gray-700">
                        <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover">
                      </div>
                      <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">${series.title}</h3>
                        <p class="text-gray-400 text-sm mb-4">${series.synopsis.slice(0, 120)}...</p>
                        <div class="flex items-center justify-between">
                          <button class="view-series-btn bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition" data-series-id="${series.id}">
                            Ver Serie
                          </button>
                          ${isAdmin ? `
                            <button class="delete-series-month-btn text-red-500 hover:text-red-400 font-bold transition" data-record-id="${sm.__backendId}">
                              Eliminar
                            </button>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </section>
            
            <!-- Encuestas -->
            <section>
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Encuestas</h2>
                ${isAdmin ? `
                  <button id="add-poll-btn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                    + Crear Encuesta
                  </button>
                ` : ''}
              </div>
              
              ${polls.length === 0 ? '<p class="text-gray-400">No hay encuestas activas</p>' : ''}
              
              <div class="space-y-6">
                ${polls.map(poll => {
                  const options = JSON.parse(poll.poll_options || '[]');
                  const pollVotes = state.allRecords.filter(r => r.poll_vote_poll_id === poll.poll_id);
                  const userVote = userVotes.find(v => v.poll_vote_poll_id === poll.poll_id);
                  const hasVoted = !!userVote;
                  const totalVotes = pollVotes.length;
                  
                  return `
                    <div class="bg-gray-800 rounded-xl p-6">
                      <div class="flex items-start justify-between mb-4">
                        <h3 class="text-xl font-bold">${poll.poll_title}</h3>
                        ${isAdmin ? `
                          <button class="delete-poll-btn text-red-500 hover:text-red-400 font-bold transition" data-record-id="${poll.__backendId}">
                            Eliminar
                          </button>
                        ` : ''}
                      </div>
                      
                      <div class="space-y-3">
                        ${options.map((option, idx) => {
                          const optionVotes = pollVotes.filter(v => v.poll_vote_option === option).length;
                          const percentage = totalVotes > 0 ? Math.round((optionVotes / totalVotes) * 100) : 0;
                          const isSelected = userVote?.poll_vote_option === option;
                          
                          return `
                            <button class="poll-option-btn w-full relative overflow-hidden bg-gray-700 hover:bg-gray-600 rounded-lg p-4 transition ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''} ${isSelected ? 'ring-2 ring-green-500' : ''}" data-poll-id="${poll.poll_id}" data-option="${option}" ${hasVoted || state.isGuest ? 'disabled' : ''}>
                              ${hasVoted ? `
                                <div class="absolute inset-0 bg-green-500/20" style="width: ${percentage}%; transition: width 0.3s ease;"></div>
                              ` : ''}
                              <div class="relative flex items-center justify-between">
                                <span class="font-semibold">${option}</span>
                                ${hasVoted ? `<span class="text-sm font-bold">${percentage}%</span>` : ''}
                              </div>
                            </button>
                          `;
                        }).join('')}
                      </div>
                      
                      <div class="mt-4 text-sm text-gray-400">
                        ${totalVotes} voto${totalVotes !== 1 ? 's' : ''} total${totalVotes !== 1 ? 'es' : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </section>
          </main>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => navigateTo('home'));
      
      document.getElementById('add-series-month-btn')?.addEventListener('click', () => {
        showSeriesSelector('month');
      });
      
      document.getElementById('add-poll-btn')?.addEventListener('click', () => {
        showPollCreator();
      });
      
      document.querySelectorAll('.delete-series-month-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const recordId = btn.dataset.recordId;
          const record = state.allRecords.find(r => r.__backendId === recordId);
          
          if (record) {
            btn.disabled = true;
            btn.textContent = 'Eliminando...';
            
            const result = await window.activeDataSdk.delete(record);
            if (result.isOk) {
              showToast('Serie eliminada', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
              btn.textContent = 'Eliminar';
            }
          }
        });
      });
      
      document.querySelectorAll('.delete-poll-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const recordId = btn.dataset.recordId;
          const record = state.allRecords.find(r => r.__backendId === recordId);
          
          if (record) {
            btn.disabled = true;
            btn.textContent = 'Eliminando...';
            
            const result = await window.activeDataSdk.delete(record);
            if (result.isOk) {
              showToast('Encuesta eliminada', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
              btn.textContent = 'Eliminar';
            }
          }
        });
      });
      
      document.querySelectorAll('.view-series-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const seriesId = btn.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
      
      document.querySelectorAll('.poll-option-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (state.isGuest) {
            showToast('Inicia sesi√≥n para votar', 'info');
            return;
          }
          
          const pollId = btn.dataset.pollId;
          const option = btn.dataset.option;
          
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            return;
          }
          
          btn.disabled = true;
          
          const result = await window.activeDataSdk.create({
            poll_vote_poll_id: pollId,
            poll_vote_option: option,
            user_profile: state.user.uid
          });
          
          if (result.isOk) {
            showToast('Voto registrado', 'success');
          } else {
            showToast('Error al votar', 'error');
            btn.disabled = false;
          }
        });
      });
    }
    
    function showSeriesSelector(type) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-in';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-auto slide-up">
          <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Seleccionar Serie</h3>
            <button class="close-modal text-gray-400 hover:text-white transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="p-6">
            <div class="grid grid-cols-2 gap-4">
              ${SERIES_DATA.map(series => `
                <button class="series-select-btn bg-gray-700 hover:bg-gray-600 rounded-lg p-4 transition text-left" data-series-id="${series.id}">
                  <div class="aspect-[2/3] bg-gray-600 rounded-lg mb-3 overflow-hidden">
                    <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover">
                  </div>
                  <h4 class="font-bold text-sm mb-1">${series.title}</h4>
                  <p class="text-xs text-gray-400">${series.genre} ‚Ä¢ ${series.country}</p>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      modal.querySelectorAll('.series-select-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const seriesId = btn.dataset.seriesId;
          
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            return;
          }
          
          btn.disabled = true;
          
          const result = await window.activeDataSdk.create({
            series_month_series_id: seriesId,
            series_month_created_by: state.user.uid
          });
          
          if (result.isOk) {
            showToast('Serie agregada', 'success');
            modal.remove();
          } else {
            showToast('Error al agregar serie', 'error');
            btn.disabled = false;
          }
        });
      });
    }
    
    function showPollCreator() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-in';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full slide-up">
          <div class="border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Crear Encuesta</h3>
            <button class="close-modal text-gray-400 hover:text-white transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="poll-creator-form" class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2">T√≠tulo de la Encuesta</label>
              <input type="text" id="poll-title" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition">
            </div>
            
            <div>
              <label class="block text-sm font-semibold mb-2">Opciones (2-4)</label>
              <input type="text" id="poll-option-1" placeholder="Opci√≥n 1" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition mb-2">
              <input type="text" id="poll-option-2" placeholder="Opci√≥n 2" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition mb-2">
              <input type="text" id="poll-option-3" placeholder="Opci√≥n 3 (opcional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition mb-2">
              <input type="text" id="poll-option-4" placeholder="Opci√≥n 4 (opcional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition">
            </div>
            
            <button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-lg ripple-effect transition">
              Crear Encuesta
            </button>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      modal.querySelector('#poll-creator-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('poll-title').value.trim();
        const option1 = document.getElementById('poll-option-1').value.trim();
        const option2 = document.getElementById('poll-option-2').value.trim();
        const option3 = document.getElementById('poll-option-3').value.trim();
        const option4 = document.getElementById('poll-option-4').value.trim();
        
        const options = [option1, option2, option3, option4].filter(o => o);
        
        if (options.length < 2) {
          showToast('Debes agregar al menos 2 opciones', 'error');
          return;
        }
        
        if (state.allRecords.length >= 999) {
          showToast('L√≠mite de 999 registros alcanzado', 'error');
          return;
        }
        
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Creando...';
        
        const result = await window.activeDataSdk.create({
          poll_id: 'poll_' + Date.now(),
          poll_title: title,
          poll_options: JSON.stringify(options),
          poll_created_by: state.user.uid
        });
        
        if (result.isOk) {
          showToast('Encuesta creada', 'success');
          modal.remove();
        } else {
          showToast('Error al crear encuesta', 'error');
          btn.disabled = false;
          btn.textContent = 'Crear Encuesta';
        }
      });
    }
    
    // Render profile
    function renderProfile() {
      const app = document.getElementById('app');
      
      const userProfile = state.allRecords.find(r => r.user_profile === state.user?.uid);
      const username = userProfile?.username || state.user?.displayName || 'Usuario';
      const subname = userProfile?.subname || '';
      const email = userProfile?.email || state.user?.email || '';
      const avatarUrl = userProfile?.avatar_url || '';
      
      const userRatings = state.allRecords.filter(r => r.rating_series_id && r.user_profile === state.user?.uid);
      const userEpisodes = state.allRecords.filter(r => r.episode_series_id && r.watched && r.user_profile === state.user?.uid);
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <header class="sticky top-0 z-40 glassmorphism border-b border-gray-700">
            <div class="max-w-screen-xl mx-auto px-6 py-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <button id="back-btn" class="text-green-500 hover:text-green-400 transition">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h1 class="text-2xl md:text-3xl font-bold">Mi Perfil</h1>
              </div>
              
              ${!state.isGuest ? `
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                  Cerrar Sesi√≥n
                </button>
              ` : `
                <button id="login-from-guest-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                  Iniciar Sesi√≥n
                </button>
              `}
            </div>
          </header>
          
          <main class="max-w-screen-xl mx-auto px-6 py-8">
            <!-- Profile info -->
            <div class="bg-gray-800 rounded-2xl p-8 mb-8">
              <div class="flex flex-col md:flex-row items-center gap-6 mb-6">
                <button id="change-avatar-btn" class="w-20 h-20 rounded-full overflow-hidden border-4 border-green-500 hover:scale-110 transition ${avatarUrl ? '' : 'avatar-gradient'} ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}">
                  ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-white font-bold text-2xl">U</div>'}
                </button>
                
                <div class="flex-1 text-center md:text-left">
                  <div class="mb-2">
                    <input type="text" id="username-input" value="${username}" class="text-2xl font-bold bg-transparent border-b-2 border-transparent hover:border-green-500 focus:border-green-500 focus:outline-none transition px-2 ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}" ${state.isGuest ? 'disabled' : ''}>
                  </div>
                  <div class="mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-gray-400">@</span>
                      <input type="text" id="subname-input" value="${subname}" placeholder="tu_nombre_usuario" class="text-base text-gray-400 bg-transparent border-b-2 border-transparent hover:border-green-500 focus:border-green-500 focus:outline-none transition px-2 flex-1 ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}" ${state.isGuest ? 'disabled' : ''}>
                    </div>
                  </div>
                  ${!state.isGuest ? `<p class="text-sm text-gray-400">${email}</p>` : '<p class="text-sm text-gray-400">Modo Invitado</p>'}
                </div>
              </div>
              
              ${!state.isGuest ? `
                <div class="flex gap-4">
                  <button id="save-profile-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-2 rounded-lg ripple-effect transition">
                    Guardar Cambios
                  </button>
                </div>
              ` : ''}
            </div>
            
            <!-- Stats -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
              <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-bold mb-2">Series Calificadas</h3>
                <p class="text-4xl font-bold text-green-500">${userRatings.length}</p>
              </div>
              
              <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-bold mb-2">Episodios Vistos</h3>
                <p class="text-4xl font-bold text-pink-500">${userEpisodes.length}</p>
              </div>
            </div>
            
            <!-- Mi Lista -->
            <div class="mb-8">
              <h2 class="text-2xl font-bold mb-6">Mi Lista</h2>
              ${(() => {
                const myListRecords = state.allRecords.filter(r => r.my_list_series_id && r.user_profile === state.user?.uid);
                
                if (myListRecords.length === 0) {
                  return '<div class="bg-gray-800 rounded-xl p-8 text-center text-gray-400">No has agregado series a tu lista a√∫n</div>';
                }
                
                return `
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                    ${myListRecords.map(record => {
                      const series = SERIES_DATA.find(s => s.id === record.my_list_series_id);
                      if (!series) return '';
                      return createSeriesCard(series);
                    }).join('')}
                  </div>
                `;
              })()}
            </div>
            
            ${state.isGuest ? `
              <div class="bg-yellow-500/20 border border-yellow-500 rounded-xl p-6 text-center">
                <p class="text-yellow-500 font-semibold mb-4">Est√°s en modo invitado. Inicia sesi√≥n para guardar tu progreso y personalizar tu perfil.</p>
                <button id="invite-login-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-3 rounded-lg ripple-effect transition">
                  Crear Cuenta o Iniciar Sesi√≥n
                </button>
              </div>
            ` : ''}
          </main>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => navigateTo('home'));
      
      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        if (!auth) return;
        
        await auth.signOut();
        state.user = null;
        state.isGuest = false;
        showToast('Sesi√≥n cerrada', 'success');
        navigateTo('login');
      });
      
      document.getElementById('login-from-guest-btn')?.addEventListener('click', () => {
        state.isGuest = false;
        navigateTo('login');
      });
      
      document.getElementById('invite-login-btn')?.addEventListener('click', () => {
        state.isGuest = false;
        navigateTo('login');
      });
      
      document.getElementById('change-avatar-btn')?.addEventListener('click', () => {
        if (state.isGuest) {
          showToast('Inicia sesi√≥n para cambiar avatar', 'info');
          return;
        }
        showAvatarSelector();
      });
      
      // Event listeners for series cards in Mi Lista
      document.querySelectorAll('.series-card').forEach(card => {
        card.addEventListener('click', () => {
          const seriesId = card.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
      
      document.getElementById('save-profile-btn')?.addEventListener('click', async () => {
        const newUsername = document.getElementById('username-input').value.trim();
        const newSubname = document.getElementById('subname-input').value.trim();
        
        if (!newUsername) {
          showToast('El nombre de usuario no puede estar vac√≠o', 'error');
          return;
        }
        
        const btn = document.getElementById('save-profile-btn');
        btn.disabled = true;
        btn.textContent = 'Guardando...';
        
        const existingProfile = state.allRecords.find(r => r.user_profile === state.user.uid);
        
        if (existingProfile) {
          existingProfile.username = newUsername;
          existingProfile.subname = newSubname;
          const result = await window.activeDataSdk.update(existingProfile);
          
          if (result.isOk) {
            showToast('Perfil actualizado', 'success');
          } else {
            showToast('Error al actualizar perfil', 'error');
          }
        } else {
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            btn.disabled = false;
            btn.textContent = 'Guardar Cambios';
            return;
          }
          
          const result = await window.activeDataSdk.create({
            user_profile: state.user.uid,
            username: newUsername,
            subname: newSubname,
            avatar_series_id: '',
            avatar_character_id: '',
            avatar_url: '',
            email: state.user.email
          });
          
          if (result.isOk) {
            showToast('Perfil creado', 'success');
          } else {
            showToast('Error al crear perfil', 'error');
          }
        }
        
        btn.disabled = false;
        btn.textContent = 'Guardar Cambios';
      });
    }
    
    function showAvatarSelector() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-in';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-auto slide-up">
          <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Seleccionar Avatar</h3>
            <button class="close-modal text-gray-400 hover:text-white transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="p-6 space-y-8">
            ${AVATAR_LIBRARY.map(seriesGroup => `
              <div>
                <h4 class="text-lg font-bold mb-4">${seriesGroup.series}</h4>
                <div class="flex gap-4 overflow-x-auto pb-2">
                  ${seriesGroup.characters.map(char => `
                    <button class="avatar-option flex-shrink-0 w-20 h-20 rounded-full overflow-hidden hover:scale-110 transition border-4 border-transparent hover:border-green-500" data-series="${seriesGroup.series}" data-char-id="${char.id}" data-url="${char.url}">
                      <img src="${char.url}" alt="${char.name}" class="w-full h-full object-cover">
                    </button>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      modal.querySelectorAll('.avatar-option').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!window.activeDataSdk) {
            showToast('Base de datos no disponible', 'error');
            return;
          }
          
          const series = btn.dataset.series;
          const charId = btn.dataset.charId;
          const url = btn.dataset.url;
          
          btn.disabled = true;
          
          const existingProfile = state.allRecords.find(r => r.user_profile === state.user.uid);
          
          if (existingProfile) {
            existingProfile.avatar_series_id = series;
            existingProfile.avatar_character_id = charId;
            existingProfile.avatar_url = url;
            
            const result = await window.activeDataSdk.update(existingProfile);
            
            if (result.isOk) {
              showToast('Avatar actualizado', 'success');
              modal.remove();
            } else {
              showToast('Error al actualizar avatar', 'error');
              btn.disabled = false;
            }
          } else {
            if (state.allRecords.length >= 999) {
              showToast('L√≠mite de 999 registros alcanzado', 'error');
              btn.disabled = false;
              return;
            }
            
            const result = await window.activeDataSdk.create({
              user_profile: state.user.uid,
              username: state.user.displayName || 'Usuario',
              subname: '',
              avatar_series_id: series,
              avatar_character_id: charId,
              avatar_url: url,
              email: state.user.email
            });
            
            if (result.isOk) {
              showToast('Avatar actualizado', 'success');
              modal.remove();
            } else {
              showToast('Error al crear perfil', 'error');
              btn.disabled = false;
            }
          }
        });
      });
    }
    
    // Start app
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b63d232f5e51a50',t:'MTc2NzEyMTY1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
